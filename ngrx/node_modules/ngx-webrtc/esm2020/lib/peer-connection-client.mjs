import { EventEmitter } from '@angular/core';
import { BehaviorSubject, Subject } from 'rxjs';
import { PeerConnectionClientSignalMessageType } from './enums/peer-connection-client-signal-message-type';
import { SdpUtils } from './sdp-utils';
import { UtilityService } from './services/utility.service';
export class PeerConnectionClient {
    constructor(settings) {
        this.started = false;
        this.isInitiator = false;
        this.hasRemoteSdp = false;
        this.messageQueue = [];
        this.isNegotiating = false;
        this.id = UtilityService.getRandom(6);
        this.DEFAULT_SDP_OFFER_OPTIONS = {
            offerToReceiveAudio: true,
            offerToReceiveVideo: true,
        };
        /**
         * messages send by the peer connection
         */
        this.signalingMessage = new EventEmitter();
        /**
         * triggered when new candidate is available initial value is `null`
         */
        this.seeNewCandidate$ = new BehaviorSubject(null);
        /**
         * triggered when a remote stream is added @deprecated use remoteTrackAdded
         */
        this.remoteStreamAdded = new EventEmitter();
        /**
         * triggered when a remote track is added
         */
        this.remoteTrackAdded = new EventEmitter();
        /**
         * triggered when the `RTCSignalingState` is changed inital value is `null`
         */
        this.signalState$ = new BehaviorSubject(null);
        /**
         * triggered if an error occure inital value is `null`
         */
        this.error$ = new BehaviorSubject(null);
        /**
         * triggered when the connected user toggle share screen, inital value is `false`
         */
        this.useShareScreen$ = new BehaviorSubject(false);
        /**
         * triggered when remote description is set, inital value is `null`
         */
        this.remotesDescriptionSet = new BehaviorSubject(null);
        /**
         * triggered when connected user close connection
         */
        this.remoteHangUp = new EventEmitter();
        /**
         * triggered when the connected user asks for mute user audio
         */
        this.muteMyAudio = new EventEmitter();
        /**
         * triggered when the connected user asks for mute user video
         */
        this.muteMyVideo = new EventEmitter();
        /**
         * triggered when the connected user mutes his video
         */
        this.userMuteVideo = new EventEmitter();
        /**
         * triggered when the connected user unmutes his video
         */
        this.userUnmuteVideo = new EventEmitter();
        /**
         * triggered when the connected user mutes his audio
         */
        this.userMuteAudio = new EventEmitter();
        /**
         * triggered when the connected user unmutes his audio
         */
        this.userUnmuteAudio = new EventEmitter();
        /**
         * triggerd on need negotiation
         */
        this.negotiationNeededTriggered = new Subject();
        /**
         * triggered on I see connection state changed, inital value is `null`
         */
        this.iceConnectionState$ = new BehaviorSubject(null);
        this.startTime = performance.now();
        this.settings = settings;
        this.log(this.settings.peerConnectionConfig);
        this.connection = new RTCPeerConnection(this.settings.peerConnectionConfig);
        if (this.settings.debug) {
            window.rtcpc = this.connection;
        }
        this.connection.onicecandidate = this.onIceCandidate.bind(this);
        this.connection.ontrack = this.onRemoteTrackAdded.bind(this);
        this.connection.onsignalingstatechange = this.onSignalingStateChange.bind(this);
        this.connection.oniceconnectionstatechange = this.onIceConnectionStateChange.bind(this);
        this.connection.onnegotiationneeded = this.onnegotiationneeded.bind(this);
    }
    /**
     * Start Peer connection as caller
     * @link https://developer.mozilla.org/en-US/docs/Web/API/RTCPeerConnection/createOffer
     * @param offerOptions options for the connection
     *
     * @returns `true` when offer is made `false` if no connection available or the connection is already open
     */
    startAsCaller(offerOptions = {}) {
        this.log('startAsCaller', offerOptions);
        if (!this.connection) {
            return false;
        }
        if (this.started) {
            return false;
        }
        this.isInitiator = true;
        this.started = true;
        return this.createOffer(offerOptions);
    }
    createOffer(offerOptions = {}) {
        if (!this.connection) {
            return false;
        }
        const constraints = { ...this.DEFAULT_SDP_OFFER_OPTIONS, ...offerOptions };
        this.log('Sending offer to peer, with constraints: \n\'' + JSON.stringify(constraints) + '\'.');
        this.connection.createOffer(constraints)
            .then(this.setLocalSdpAndNotify.bind(this))
            .catch(this.onError.bind(this, 'createOffer'));
        return true;
    }
    /**
     * Start Peer connection as callee
     * @param initialMessages messages that are collected before the `PeerConnectionClient` instance is created
     * @returns `true` when messages are queed or processed `false` if no connection available or the connection is already open
     */
    startAsCallee(initialMessages) {
        this.log('startAsCallee', initialMessages);
        if (!this.connection) {
            this.error('startAsCallee()', 'no connection');
            return false;
        }
        if (this.started) {
            this.error('startAsCallee()', 'not started');
            return false;
        }
        this.started = true;
        if (initialMessages && initialMessages.length > 0) {
            // Convert received messages to JSON objects and add them to the message
            // queue.
            for (const message of initialMessages) {
                this.receiveSignalingMessage(message);
            }
            return true;
        }
        // We may have queued messages received from the signaling channel before
        // started.
        if (this.messageQueue.length > 0) {
            this.drainMessageQueue();
        }
        return true;
    }
    /**
     * send `PeerConnectionClientSignalMessageType.Bye` message to connected user and close the open connection
     */
    close() {
        this.log('close');
        if (!this.connection) {
            return;
        }
        this.signalingMessage.emit({
            type: PeerConnectionClientSignalMessageType.Bye
        });
        this.connection.close();
        this.connection = null;
    }
    /**
     * send `PeerConnectionClientSignalMessageType.AudioMuted` message to connected user
     */
    audioMuted() {
        if (!this.connection) {
            return;
        }
        this.signalingMessage.emit({
            type: PeerConnectionClientSignalMessageType.AudioMuted
        });
    }
    /**
     * send `PeerConnectionClientSignalMessageType.AudioUnmuted` message to connected user
     */
    audioUnmuted() {
        if (!this.connection) {
            return;
        }
        this.signalingMessage.emit({
            type: PeerConnectionClientSignalMessageType.AudioUnmuted
        });
    }
    /**
     * send `PeerConnectionClientSignalMessageType.VideoMuted` message to connected user
     */
    videoMuted() {
        if (!this.connection) {
            return;
        }
        this.signalingMessage.emit({
            type: PeerConnectionClientSignalMessageType.VideoMuted
        });
    }
    /**
     * send `PeerConnectionClientSignalMessageType.VideoUnmuted` message to connected user
     */
    videoUnmuted() {
        if (!this.connection) {
            return;
        }
        this.signalingMessage.emit({
            type: PeerConnectionClientSignalMessageType.VideoUnmuted
        });
    }
    /**
     * send `PeerConnectionClientSignalMessageType.RequestMuteAudio` message to connected user
     */
    requestMuteAudio() {
        this.log('requestMuteAudio');
        if (!this.connection) {
            return;
        }
        this.signalingMessage.emit({
            type: PeerConnectionClientSignalMessageType.RequestMuteAudio
        });
    }
    /**
     * send `PeerConnectionClientSignalMessageType.RequestMuteVideo` message to connected user
     */
    requestMuteVideo() {
        this.log('requestMuteVideo');
        if (!this.connection) {
            return;
        }
        this.signalingMessage.emit({
            type: PeerConnectionClientSignalMessageType.RequestMuteVideo
        });
    }
    /**
     * send `PeerConnectionClientSignalMessageType.StartShareScreen` message to connected user
     */
    startShareScreen() {
        this.log('startShareScreen');
        if (!this.connection) {
            return;
        }
        this.signalingMessage.emit({
            type: PeerConnectionClientSignalMessageType.StartShareScreen
        });
    }
    /**
     * send `PeerConnectionClientSignalMessageType.StopShareScreen` message to connected user
     */
    stopShareScreen() {
        this.log('startShareScreen');
        if (!this.connection) {
            return;
        }
        this.signalingMessage.emit({
            type: PeerConnectionClientSignalMessageType.StopShareScreen
        });
    }
    /**
     * get peer connection state
     * @returns `null` if not connected otherwiese an object of `RTCSignalingState`, `RTCIceGatheringState` and `RTCIceConnectionState`
     */
    getPeerConnectionStates() {
        if (!this.connection) {
            return null;
        }
        return {
            signalingState: this.connection.signalingState,
            iceGatheringState: this.connection.iceGatheringState,
            iceConnectionState: this.connection.iceConnectionState
        };
    }
    /**
     * get the connection stats of a track in the connection
     * @param track `MediaStreamTrack` to check state for
     * @returns Promise that resolves to `RTCStatsReport`
     */
    getPeerConnectionStats(track) {
        if (!this.connection) {
            return Promise.reject();
        }
        return this.connection.getStats(track);
    }
    /**
     * add a `MediaStreamTrack` to the connection
     * @param track `MediaStreamTrack` to be added to the connection.
     */
    addTrack(track) {
        this.log('addTrack', track);
        if (this.connection) {
            const sender = this.connection.getSenders().find((s) => {
                return s?.track?.kind === track.kind;
            });
            if (sender?.track) {
                this.log('existing track found using replaceTrack instead');
                this.replaceTrack(track);
            }
            else {
                this.connection.addTrack(track);
            }
        }
    }
    /**
     * replace current `MediaStreamTrack` with new from parameter
     * @param track new `MediaStreamTrack`
     */
    replaceTrack(track) {
        this.log(track);
        if (this.connection) {
            const sender = this.connection.getSenders().find((s) => {
                return s?.track?.kind === track.kind;
            });
            if (!sender?.track) {
                this.log('no track found using addTrack instead');
                this.addTrack(track);
            }
            else {
                sender.replaceTrack(track);
            }
        }
    }
    /**
     * Add all `MediaStreamTrack`s of a `MediaStream` to the connection
     * @param mediaSteam `MediaStream` with tracks
     */
    addStream(mediaSteam) {
        this.log('addStream', mediaSteam);
        mediaSteam.getTracks().forEach(track => {
            this.addTrack(track);
        });
    }
    setLocalSdpAndNotify(sessionDescription) {
        if (!this.connection) {
            return;
        }
        // this.log('setLocalSdpAndNotify', sessionDescription);
        if (sessionDescription.sdp) {
            sessionDescription.sdp = SdpUtils.maybeSetOpusOptions(sessionDescription.sdp, this.settings);
            sessionDescription.sdp = SdpUtils.maybePreferAudioReceiveCodec(sessionDescription.sdp, this.settings);
            sessionDescription.sdp = SdpUtils.maybePreferVideoReceiveCodec(sessionDescription.sdp, this.settings);
            sessionDescription.sdp = SdpUtils.maybeSetAudioReceiveBitRate(sessionDescription.sdp, this.settings);
            sessionDescription.sdp = SdpUtils.maybeSetVideoReceiveBitRate(sessionDescription.sdp, this.settings);
            sessionDescription.sdp = SdpUtils.maybeRemoveVideoFec(sessionDescription.sdp, this.settings);
        }
        this.connection.setLocalDescription(sessionDescription)
            .then(() => this.log('Set session description success.'))
            .catch(this.onError.bind(this, 'setLocalDescription'));
        // Chrome version of RTCSessionDescription can't be serialized directly
        // because it JSON.stringify won't include attributes which are on the
        // object's prototype chain. By creating the message to serialize
        // explicitly we can avoid the issue.
        this.signalingMessage.emit({
            sdp: sessionDescription.sdp,
            type: sessionDescription.type
        });
    }
    filterIceCandidate(candidateObj) {
        // this.log('filterIceCandidate', candidateObj);
        const candidateStr = candidateObj.candidate;
        // Always remove TCP candidates. Not needed in this context.
        if (candidateStr.indexOf('tcp') !== -1) {
            return false;
        }
        // If we're trying to remove non-relay candidates, do that.
        if (this.settings.peerConnectionConfig.iceTransports === 'relay' && SdpUtils.iceCandidateType(candidateStr) !== 'relay') {
            return false;
        }
        return true;
    }
    onIceCandidate(event) {
        // this.log('onIceCandidate', event);
        if (event.candidate) {
            // Eat undesired candidates.
            if (this.filterIceCandidate(event.candidate)) {
                const message = {
                    type: PeerConnectionClientSignalMessageType.Candidate,
                    label: event.candidate.sdpMLineIndex,
                    id: event.candidate.sdpMid,
                    candidate: event.candidate.candidate
                };
                this.signalingMessage.emit(message);
                this.onRecordIceCandidate('Local', event.candidate);
            }
        }
        else {
            this.log('End of candidates.');
        }
    }
    handleMessageEvents(messageObj) {
        if (messageObj.type === PeerConnectionClientSignalMessageType.Bye) {
            this.remoteHangUp.emit();
        }
        else if (messageObj.type === PeerConnectionClientSignalMessageType.RequestMuteAudio) {
            this.muteMyAudio.emit();
        }
        else if (messageObj.type === PeerConnectionClientSignalMessageType.RequestMuteVideo) {
            this.muteMyVideo.emit();
        }
        else if (messageObj.type === PeerConnectionClientSignalMessageType.AudioMuted) {
            this.userMuteAudio.emit();
        }
        else if (messageObj.type === PeerConnectionClientSignalMessageType.AudioUnmuted) {
            this.userUnmuteAudio.emit();
        }
        else if (messageObj.type === PeerConnectionClientSignalMessageType.VideoMuted) {
            this.userMuteVideo.emit();
        }
        else if (messageObj.type === PeerConnectionClientSignalMessageType.VideoUnmuted) {
            this.userUnmuteVideo.emit();
        }
        else if (messageObj.type === PeerConnectionClientSignalMessageType.StartShareScreen) {
            this.useShareScreen$.next(true);
        }
        else if (messageObj.type === PeerConnectionClientSignalMessageType.StopShareScreen) {
            this.useShareScreen$.next(false);
        }
    }
    /**
     * execute this methode to set messages in the peer connection. You need a connection lay to receive messages.
     * @param message message to process
     */
    receiveSignalingMessage(message) {
        this.log('receiveSignalingMessage', message);
        let messageObj;
        if (typeof message === 'string') {
            try {
                messageObj = JSON.parse(message);
            }
            catch (error) {
                this.log('invalid json for message', message);
                return;
            }
        }
        else {
            messageObj = message;
        }
        if (this.connection?.iceGatheringState === 'complete' ||
            ((this.isInitiator && messageObj.type === PeerConnectionClientSignalMessageType.Answer) ||
                (!this.isInitiator && messageObj.type === PeerConnectionClientSignalMessageType.Offer))) {
            this.hasRemoteSdp = true;
            // Always process offer before candidates.
            this.messageQueue.unshift(messageObj);
        }
        if (messageObj.type === PeerConnectionClientSignalMessageType.Candidate) {
            this.messageQueue.push(messageObj);
        }
        this.handleMessageEvents(messageObj);
        this.drainMessageQueue();
    }
    processSignalingMessage(message) {
        this.log('processSignalingMessage', message);
        if (!this.connection) {
            return;
        }
        this.handleMessageEvents(message);
        if (message.type === PeerConnectionClientSignalMessageType.Offer && (!this.isInitiator || this.connection.iceGatheringState === 'complete')) {
            if (this.connection.signalingState !== 'stable') {
                this.log('ERROR: remote offer received in unexpected state: ' + this.connection.signalingState);
                return;
            }
            this.setRemoteSdp(message);
            this.doAnswer();
        }
        else if (message.type === PeerConnectionClientSignalMessageType.Answer && (this.isInitiator || this.connection.iceGatheringState === 'complete')) {
            if (this.connection.signalingState !== 'have-local-offer') {
                this.log('ERROR: remote answer received in unexpected state: ' +
                    this.connection.signalingState);
                return;
            }
            this.setRemoteSdp(message);
        }
        else if (message.type === PeerConnectionClientSignalMessageType.Candidate) {
            const candidate = new RTCIceCandidate({
                sdpMLineIndex: message.label,
                candidate: message.candidate
            });
            this.onRecordIceCandidate('Remote', candidate);
            this.connection.addIceCandidate(candidate)
                .then(this.log.bind(this, 'Remote candidate added successfully.'))
                .catch(this.onError.bind(this, 'addIceCandidate'));
        }
        else {
            this.log(`WARNING: unexpected message: ${message.type}`);
        }
    }
    doAnswer() {
        if (!this.connection) {
            return;
        }
        this.log('Sending answer to peer.');
        this.connection.createAnswer()
            .then(this.setLocalSdpAndNotify.bind(this))
            .catch(this.onError.bind(this, 'createAnswer'));
    }
    setRemoteSdp(message) {
        if (!this.connection) {
            return;
        }
        // this.log('setRemoteSdp', message);
        if (message.sdp) {
            message.sdp = SdpUtils.maybeSetOpusOptions(message.sdp, this.settings);
            message.sdp = SdpUtils.maybePreferAudioSendCodec(message.sdp, this.settings);
            message.sdp = SdpUtils.maybePreferVideoSendCodec(message.sdp, this.settings);
            message.sdp = SdpUtils.maybeSetAudioSendBitRate(message.sdp, this.settings);
            message.sdp = SdpUtils.maybeSetVideoSendBitRate(message.sdp, this.settings);
            message.sdp = SdpUtils.maybeSetVideoSendInitialBitRate(message.sdp, this.settings);
            message.sdp = SdpUtils.maybeRemoveVideoFec(message.sdp, this.settings);
        }
        this.connection.setRemoteDescription(new RTCSessionDescription(message))
            .then(this.onSetRemoteDescriptionSuccess.bind(this))
            .catch(this.onError.bind(this, 'setRemoteDescription'));
    }
    // When we receive messages from GAE registration and from the WSS connection,
    // we add them to a queue and drain it if conditions are right.
    drainMessageQueue() {
        // It's possible that we finish registering and receiving messages from WSS
        // before our peer connection is created or started. We need to wait for the
        // peer connection to be created and started before processing messages.
        //
        // Also, the order of messages is in general not the same as the POST order
        // from the other client because the POSTs are async and the server may handle
        // some requests faster than others. We need to process offer before
        // candidates so we wait for the offer to arrive first if we're answering.
        // Offers are added to the front of the queue.
        if (!this.connection || !this.started || !this.hasRemoteSdp) {
            return;
        }
        for (const message of this.messageQueue) {
            this.processSignalingMessage(message);
        }
        this.messageQueue = [];
    }
    // Hooks
    onIceConnectionStateChange() {
        if (!this.connection) {
            return;
        }
        this.log('ICE connection state changed to: ' + this.connection.iceConnectionState);
        if (this.connection.iceConnectionState === 'completed') {
            this.log('ICE complete time: ' +
                (window.performance.now() - this.startTime).toFixed(0) + 'ms.');
        }
        this.iceConnectionState$.next(this.connection.iceConnectionState);
    }
    onnegotiationneeded() {
        if (!this.connection) {
            return;
        }
        this.log('onnegotiationneeded');
        this.negotiationNeededTriggered.next(true);
    }
    onSignalingStateChange() {
        if (!this.connection) {
            return;
        }
        this.isNegotiating = (this.connection.signalingState !== 'stable');
        this.log('Signaling state changed to: ' + this.connection.signalingState);
        this.signalState$.next(this.connection.signalingState);
    }
    onError(source, error) {
        this.log(`${source}:`, error);
        this.error$.next({ source, error });
    }
    onRecordIceCandidate(location, candidateObj) {
        if (candidateObj?.candidate) {
            this.seeNewCandidate$.next({ location, candidate: candidateObj.candidate });
        }
        else {
            this.log('see new candidate but candidate is null', { location, candidate: candidateObj });
        }
    }
    onRemoteTrackAdded(event) {
        this.remoteStreamAdded.emit({
            track: event.track,
            kind: event.track.kind
        });
        this.remoteTrackAdded.emit({
            track: event.track,
            kind: event.track.kind
        });
    }
    onSetRemoteDescriptionSuccess() {
        if (!this.connection) {
            return;
        }
        this.log('Set remote session description success.');
        // By now all onaddstream events for the setRemoteDescription have fired,
        // so we can know if the peer has any remote video streams that we need
        // to wait for. Otherwise, transition immediately to the active state.
        const remoteStreams = this.connection.getReceivers();
        if (remoteStreams.length) {
            for (const stream of remoteStreams) {
                this.remotesDescriptionSet.next(stream.track);
            }
        }
    }
    log(...args) {
        if (this.settings.debug) {
            console.log(this.id, ...args);
        }
    }
    error(...args) {
        if (this.settings.debug) {
            console.error(this.id, ...args);
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGVlci1jb25uZWN0aW9uLWNsaWVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL2xpYnMvbmd4LXdlYnJ0Yy9zcmMvbGliL3BlZXItY29ubmVjdGlvbi1jbGllbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUM3QyxPQUFPLEVBQUUsZUFBZSxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUdoRCxPQUFPLEVBQUUscUNBQXFDLEVBQUUsTUFBTSxvREFBb0QsQ0FBQztBQUMzRyxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBR3ZDLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUU1RCxNQUFNLE9BQU8sb0JBQW9CO0lBb0YvQixZQUFZLFFBQXNDO1FBakYxQyxZQUFPLEdBQUcsS0FBSyxDQUFDO1FBQ2hCLGdCQUFXLEdBQUcsS0FBSyxDQUFDO1FBQ3BCLGlCQUFZLEdBQUcsS0FBSyxDQUFDO1FBQ3JCLGlCQUFZLEdBQXdDLEVBQUUsQ0FBQztRQUd2RCxrQkFBYSxHQUFHLEtBQUssQ0FBQztRQUN0QixPQUFFLEdBQUcsY0FBYyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN4Qiw4QkFBeUIsR0FBb0I7WUFDNUQsbUJBQW1CLEVBQUUsSUFBSTtZQUN6QixtQkFBbUIsRUFBRSxJQUFJO1NBQzFCLENBQUM7UUFDRjs7V0FFRztRQUNJLHFCQUFnQixHQUFHLElBQUksWUFBWSxFQUFxQyxDQUFDO1FBQ2hGOztXQUVHO1FBQ0kscUJBQWdCLEdBQUcsSUFBSSxlQUFlLENBQStDLElBQUksQ0FBQyxDQUFDO1FBQ2xHOztXQUVHO1FBQ0ksc0JBQWlCLEdBQUcsSUFBSSxZQUFZLEVBQWUsQ0FBQztRQUMzRDs7V0FFRztRQUNJLHFCQUFnQixHQUFHLElBQUksWUFBWSxFQUFlLENBQUM7UUFD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O1lBQ3ZCLE9BQU8sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEVBQUUsRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDO1NBQ2pDO0lBQ0gsQ0FBQztDQUVGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRXZlbnRFbWl0dGVyIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IFBlZXJDb25uZWN0aW9uQ2xpZW50U2V0dGluZ3MgfSBmcm9tICcuL2ludGVyZmFjZXMvcGVlci1jb25uZWN0aW9uLWNsaWVudC1zZXR0aW5ncyc7XG5pbXBvcnQgeyBQZWVyQ29ubmVjdGlvbkNsaWVudFNpZ25hbE1lc3NhZ2UgfSBmcm9tICcuL2ludGVyZmFjZXMvcGVlci1jb25uZWN0aW9uLWNsaWVudC1zaWduYWwtbWVzc2FnZSc7XG5pbXBvcnQgeyBQZWVyQ29ubmVjdGlvbkNsaWVudFNpZ25hbE1lc3NhZ2VUeXBlIH0gZnJvbSAnLi9lbnVtcy9wZWVyLWNvbm5lY3Rpb24tY2xpZW50LXNpZ25hbC1tZXNzYWdlLXR5cGUnO1xuaW1wb3J0IHsgU2RwVXRpbHMgfSBmcm9tICcuL3NkcC11dGlscyc7XG5pbXBvcnQgeyBTdHJlYW1UcmFjayB9IGZyb20gJy4vaW50ZXJmYWNlcy9zdHJlYW0tdHJhY2snO1xuaW1wb3J0IHsgU3RyZWFtVHlwZSB9IGZyb20gJy4vZW51bXMvc3RyZWFtLXR5cGUnO1xuaW1wb3J0IHsgVXRpbGl0eVNlcnZpY2UgfSBmcm9tICcuL3NlcnZpY2VzL3V0aWxpdHkuc2VydmljZSc7XG5cbmV4cG9ydCBjbGFzcyBQZWVyQ29ubmVjdGlvbkNsaWVudCB7XG5cbiAgcHJpdmF0ZSBzdGFydFRpbWU6IG51bWJlcjtcbiAgcHJpdmF0ZSBzdGFydGVkID0gZmFsc2U7XG4gIHByaXZhdGUgaXNJbml0aWF0b3IgPSBmYWxzZTtcbiAgcHJpdmF0ZSBoYXNSZW1vdGVTZHAgPSBmYWxzZTtcbiAgcHJpdmF0ZSBtZXNzYWdlUXVldWU6IFBlZXJDb25uZWN0aW9uQ2xpZW50U2lnbmFsTWVzc2FnZVtdID0gW107XG4gIHByaXZhdGUgY29ubmVjdGlvbjogUlRDUGVlckNvbm5lY3Rpb24gfCBudWxsO1xuICBwcml2YXRlIHNldHRpbmdzOiBQZWVyQ29ubmVjdGlvbkNsaWVudFNldHRpbmdzO1xuICBwcml2YXRlIGlzTmVnb3RpYXRpbmcgPSBmYWxzZTtcbiAgcHJpdmF0ZSBpZCA9IFV0aWxpdHlTZXJ2aWNlLmdldFJhbmRvbSg2KTtcbiAgcHJpdmF0ZSByZWFkb25seSBERUZBVUxUX1NEUF9PRkZFUl9PUFRJT05TOiBSVENPZmZlck9wdGlvbnMgPSB7XG4gICAgb2ZmZXJUb1JlY2VpdmVBdWRpbzogdHJ1ZSxcbiAgICBvZmZlclRvUmVjZWl2ZVZpZGVvOiB0cnVlLFxuICB9O1xuICAvKipcbiAgICogbWVzc2FnZXMgc2VuZCBieSB0aGUgcGVlciBjb25uZWN0aW9uXG4gICAqL1xuICBwdWJsaWMgc2lnbmFsaW5nTWVzc2FnZSA9IG5ldyBFdmVudEVtaXR0ZXI8UGVlckNvbm5lY3Rpb25DbGllbnRTaWduYWxNZXNzYWdlPigpO1xuICAvKipcbiAgICogdHJpZ2dlcmVkIHdoZW4gbmV3IGNhbmRpZGF0ZSBpcyBhdmFpbGFibGUgaW5pdGlhbCB2YWx1ZSBpcyBgbnVsbGBcbiAgICovXG4gIHB1YmxpYyBzZWVOZXdDYW5kaWRhdGUkID0gbmV3IEJlaGF2aW9yU3ViamVjdDx7bG9jYXRpb246IHN0cmluZywgY2FuZGlkYXRlOiBzdHJpbmd9IHwgbnVsbD4obnVsbCk7XG4gIC8qKlxuICAgKiB0cmlnZ2VyZWQgd2hlbiBhIHJlbW90ZSBzdHJlYW0gaXMgYWRkZWQgQGRlcHJlY2F0ZWQgdXNlIHJlbW90ZVRyYWNrQWRkZWRcbiAgICovXG4gIHB1YmxpYyByZW1vdGVTdHJlYW1BZGRlZCA9IG5ldyBFdmVudEVtaXR0ZXI8U3RyZWFtVHJhY2s+KCk7XG4gIC8qKlxuICAgKiB0cmlnZ2VyZWQgd2hlbiBhIHJlbW90ZSB0cmFjayBpcyBhZGRlZFxuICAgKi9cbiAgcHVibGljIHJlbW90ZVRyYWNrQWRkZWQgPSBuZXcgRXZlbnRFbWl0dGVyPFN0cmVhbVRyYWNrPigpO1xuICAvKipcbiAgICogdHJpZ2dlcmVkIHdoZW4gdGhlIGBSVENTaWduYWxpbmdTdGF0ZWAgaXMgY2hhbmdlZCBpbml0YWwgdmFsdWUgaXMgYG51bGxgXG4gICAqL1xuICBwdWJsaWMgc2lnbmFsU3RhdGUkID0gbmV3IEJlaGF2aW9yU3ViamVjdDxSVENTaWduYWxpbmdTdGF0ZSB8IG51bGw+KG51bGwpO1xuICAvKipcbiAgICogdHJpZ2dlcmVkIGlmIGFuIGVycm9yIG9jY3VyZSBpbml0YWwgdmFsdWUgaXMgYG51bGxgXG4gICAqL1xuICBwdWJsaWMgZXJyb3IkID0gbmV3IEJlaGF2aW9yU3ViamVjdDx7c291cmNlOiBzdHJpbmcsIGVycm9yPzogRXJyb3J9IHwgbnVsbD4obnVsbCk7XG4gIC8qKlxuICAgKiB0cmlnZ2VyZWQgd2hlbiB0aGUgY29ubmVjdGVkIHVzZXIgdG9nZ2xlIHNoYXJlIHNjcmVlbiwgaW5pdGFsIHZhbHVlIGlzIGBmYWxzZWBcbiAgICovXG4gIHB1YmxpYyB1c2VTaGFyZVNjcmVlbiQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PGJvb2xlYW4+KGZhbHNlKTtcbiAgLyoqXG4gICAqIHRyaWdnZXJlZCB3aGVuIHJlbW90ZSBkZXNjcmlwdGlvbiBpcyBzZXQsIGluaXRhbCB2YWx1ZSBpcyBgbnVsbGBcbiAgICovXG4gIHB1YmxpYyByZW1vdGVzRGVzY3JpcHRpb25TZXQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PE1lZGlhU3RyZWFtVHJhY2sgfCBudWxsPihudWxsKTtcbiAgLyoqXG4gICAqIHRyaWdnZXJlZCB3aGVuIGNvbm5lY3RlZCB1c2VyIGNsb3NlIGNvbm5lY3Rpb25cbiAgICovXG4gIHB1YmxpYyByZW1vdGVIYW5nVXAgPSBuZXcgRXZlbnRFbWl0dGVyPHZvaWQ+KCk7XG4gIC8qKlxuICAgKiB0cmlnZ2VyZWQgd2hlbiB0aGUgY29ubmVjdGVkIHVzZXIgYXNrcyBmb3IgbXV0ZSB1c2VyIGF1ZGlvXG4gICAqL1xuICBwdWJsaWMgbXV0ZU15QXVkaW8gPSBuZXcgRXZlbnRFbWl0dGVyPHZvaWQ+KCk7XG4gIC8qKlxuICAgKiB0cmlnZ2VyZWQgd2hlbiB0aGUgY29ubmVjdGVkIHVzZXIgYXNrcyBmb3IgbXV0ZSB1c2VyIHZpZGVvXG4gICAqL1xuICBwdWJsaWMgbXV0ZU15VmlkZW8gPSBuZXcgRXZlbnRFbWl0dGVyPHZvaWQ+KCk7XG4gIC8qKlxuICAgKiB0cmlnZ2VyZWQgd2hlbiB0aGUgY29ubmVjdGVkIHVzZXIgbXV0ZXMgaGlzIHZpZGVvXG4gICAqL1xuICBwdWJsaWMgdXNlck11dGVWaWRlbyA9IG5ldyBFdmVudEVtaXR0ZXI8dm9pZD4oKTtcbiAgLyoqXG4gICAqIHRyaWdnZXJlZCB3aGVuIHRoZSBjb25uZWN0ZWQgdXNlciB1bm11dGVzIGhpcyB2aWRlb1xuICAgKi9cbiAgcHVibGljIHVzZXJVbm11dGVWaWRlbyA9IG5ldyBFdmVudEVtaXR0ZXI8dm9pZD4oKTtcbiAgLyoqXG4gICAqIHRyaWdnZXJlZCB3aGVuIHRoZSBjb25uZWN0ZWQgdXNlciBtdXRlcyBoaXMgYXVkaW9cbiAgICovXG4gIHB1YmxpYyB1c2VyTXV0ZUF1ZGlvID0gbmV3IEV2ZW50RW1pdHRlcjx2b2lkPigpO1xuICAvKipcbiAgICogdHJpZ2dlcmVkIHdoZW4gdGhlIGNvbm5lY3RlZCB1c2VyIHVubXV0ZXMgaGlzIGF1ZGlvXG4gICAqL1xuICBwdWJsaWMgdXNlclVubXV0ZUF1ZGlvID0gbmV3IEV2ZW50RW1pdHRlcjx2b2lkPigpO1xuICAvKipcbiAgICogdHJpZ2dlcmQgb24gbmVlZCBuZWdvdGlhdGlvblxuICAgKi9cbiAgcHVibGljIG5lZ290aWF0aW9uTmVlZGVkVHJpZ2dlcmVkID0gbmV3IFN1YmplY3Q8Ym9vbGVhbj4oKTtcbiAgLyoqXG4gICAqIHRyaWdnZXJlZCBvbiBJIHNlZSBjb25uZWN0aW9uIHN0YXRlIGNoYW5nZWQsIGluaXRhbCB2YWx1ZSBpcyBgbnVsbGBcbiAgICovXG4gIHB1YmxpYyBpY2VDb25uZWN0aW9uU3RhdGUkID0gbmV3IEJlaGF2aW9yU3ViamVjdDxSVENJY2VDb25uZWN0aW9uU3RhdGV8IG51bGw+KG51bGwpO1xuXG4gIGNvbnN0cnVjdG9yKHNldHRpbmdzOiBQZWVyQ29ubmVjdGlvbkNsaWVudFNldHRpbmdzKSB7XG4gICAgdGhpcy5zdGFydFRpbWUgPSBwZXJmb3JtYW5jZS5ub3coKTtcbiAgICB0aGlzLnNldHRpbmdzID0gc2V0dGluZ3M7XG4gICAgdGhpcy5sb2codGhpcy5zZXR0aW5ncy5wZWVyQ29ubmVjdGlvbkNvbmZpZyk7XG4gICAgdGhpcy5jb25uZWN0aW9uID0gbmV3IFJUQ1BlZXJDb25uZWN0aW9uKHRoaXMuc2V0dGluZ3MucGVlckNvbm5lY3Rpb25Db25maWcpO1xuICAgIGlmICh0aGlzLnNldHRpbmdzLmRlYnVnKSB7XG4gICAgICAod2luZG93IGFzIGFueSkucnRjcGMgPSB0aGlzLmNvbm5lY3Rpb247XG4gICAgfVxuICAgIHRoaXMuY29ubmVjdGlvbi5vbmljZWNhbmRpZGF0ZSA9IHRoaXMub25JY2VDYW5kaWRhdGUuYmluZCh0aGlzKTtcbiAgICB0aGlzLmNvbm5lY3Rpb24ub250cmFjayA9IHRoaXMub25SZW1vdGVUcmFja0FkZGVkLmJpbmQodGhpcyk7XG4gICAgdGhpcy5jb25uZWN0aW9uLm9uc2lnbmFsaW5nc3RhdGVjaGFuZ2UgPSB0aGlzLm9uU2lnbmFsaW5nU3RhdGVDaGFuZ2UuYmluZCh0aGlzKTtcbiAgICB0aGlzLmNvbm5lY3Rpb24ub25pY2Vjb25uZWN0aW9uc3RhdGVjaGFuZ2UgPSB0aGlzLm9uSWNlQ29ubmVjdGlvblN0YXRlQ2hhbmdlLmJpbmQodGhpcyk7XG4gICAgdGhpcy5jb25uZWN0aW9uLm9ubmVnb3RpYXRpb25uZWVkZWQgPSB0aGlzLm9ubmVnb3RpYXRpb25uZWVkZWQuYmluZCh0aGlzKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTdGFydCBQZWVyIGNvbm5lY3Rpb24gYXMgY2FsbGVyXG4gICAqIEBsaW5rIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0FQSS9SVENQZWVyQ29ubmVjdGlvbi9jcmVhdGVPZmZlclxuICAgKiBAcGFyYW0gb2ZmZXJPcHRpb25zIG9wdGlvbnMgZm9yIHRoZSBjb25uZWN0aW9uIFxuICAgKiBcbiAgICogQHJldHVybnMgYHRydWVgIHdoZW4gb2ZmZXIgaXMgbWFkZSBgZmFsc2VgIGlmIG5vIGNvbm5lY3Rpb24gYXZhaWxhYmxlIG9yIHRoZSBjb25uZWN0aW9uIGlzIGFscmVhZHkgb3BlblxuICAgKi9cbiAgcHVibGljIHN0YXJ0QXNDYWxsZXIob2ZmZXJPcHRpb25zOiBSVENPZmZlck9wdGlvbnMgPSB7fSk6IGJvb2xlYW4ge1xuICAgIHRoaXMubG9nKCdzdGFydEFzQ2FsbGVyJywgb2ZmZXJPcHRpb25zKTtcblxuICAgIGlmICghdGhpcy5jb25uZWN0aW9uKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuc3RhcnRlZCkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIHRoaXMuaXNJbml0aWF0b3IgPSB0cnVlO1xuICAgIHRoaXMuc3RhcnRlZCA9IHRydWU7XG5cbiAgICBcbiAgICByZXR1cm4gdGhpcy5jcmVhdGVPZmZlcihvZmZlck9wdGlvbnMpO1xuICB9XG4gIFxuICBwdWJsaWMgY3JlYXRlT2ZmZXIob2ZmZXJPcHRpb25zOiBSVENPZmZlck9wdGlvbnMgPSB7fSk6IGJvb2xlYW4ge1xuICAgIGlmICghdGhpcy5jb25uZWN0aW9uKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIGNvbnN0IGNvbnN0cmFpbnRzOiBSVENPZmZlck9wdGlvbnMgPSB7Li4udGhpcy5ERUZBVUxUX1NEUF9PRkZFUl9PUFRJT05TLCAuLi5vZmZlck9wdGlvbnN9O1xuICAgIHRoaXMubG9nKCdTZW5kaW5nIG9mZmVyIHRvIHBlZXIsIHdpdGggY29uc3RyYWludHM6IFxcblxcJycgKyBKU09OLnN0cmluZ2lmeShjb25zdHJhaW50cykgKyAnXFwnLicpO1xuICAgIHRoaXMuY29ubmVjdGlvbi5jcmVhdGVPZmZlcihjb25zdHJhaW50cylcbiAgICAgICAgLnRoZW4odGhpcy5zZXRMb2NhbFNkcEFuZE5vdGlmeS5iaW5kKHRoaXMpKVxuICAgICAgICAuY2F0Y2godGhpcy5vbkVycm9yLmJpbmQodGhpcywgJ2NyZWF0ZU9mZmVyJykpO1xuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgLyoqXG4gICAqIFN0YXJ0IFBlZXIgY29ubmVjdGlvbiBhcyBjYWxsZWVcbiAgICogQHBhcmFtIGluaXRpYWxNZXNzYWdlcyBtZXNzYWdlcyB0aGF0IGFyZSBjb2xsZWN0ZWQgYmVmb3JlIHRoZSBgUGVlckNvbm5lY3Rpb25DbGllbnRgIGluc3RhbmNlIGlzIGNyZWF0ZWRcbiAgICogQHJldHVybnMgYHRydWVgIHdoZW4gbWVzc2FnZXMgYXJlIHF1ZWVkIG9yIHByb2Nlc3NlZCBgZmFsc2VgIGlmIG5vIGNvbm5lY3Rpb24gYXZhaWxhYmxlIG9yIHRoZSBjb25uZWN0aW9uIGlzIGFscmVhZHkgb3BlblxuICAgKi9cbiAgcHVibGljIHN0YXJ0QXNDYWxsZWUoaW5pdGlhbE1lc3NhZ2VzPzogc3RyaW5nW10gfCBQZWVyQ29ubmVjdGlvbkNsaWVudFNpZ25hbE1lc3NhZ2VbXSk6IGJvb2xlYW4ge1xuICAgIHRoaXMubG9nKCdzdGFydEFzQ2FsbGVlJywgaW5pdGlhbE1lc3NhZ2VzKTtcbiAgICBpZiAoIXRoaXMuY29ubmVjdGlvbikge1xuICAgICAgdGhpcy5lcnJvcignc3RhcnRBc0NhbGxlZSgpJywgJ25vIGNvbm5lY3Rpb24nKTtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5zdGFydGVkKSB7XG4gICAgICB0aGlzLmVycm9yKCdzdGFydEFzQ2FsbGVlKCknLCAnbm90IHN0YXJ0ZWQnKTtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICB0aGlzLnN0YXJ0ZWQgPSB0cnVlO1xuXG4gICAgaWYgKGluaXRpYWxNZXNzYWdlcyAmJiBpbml0aWFsTWVzc2FnZXMubGVuZ3RoID4gMCkge1xuICAgICAgLy8gQ29udmVydCByZWNlaXZlZCBtZXNzYWdlcyB0byBKU09OIG9iamVjdHMgYW5kIGFkZCB0aGVtIHRvIHRoZSBtZXNzYWdlXG4gICAgICAvLyBxdWV1ZS5cbiAgICAgIGZvciAoY29uc3QgbWVzc2FnZSBvZiBpbml0aWFsTWVzc2FnZXMpIHtcbiAgICAgICAgdGhpcy5yZWNlaXZlU2lnbmFsaW5nTWVzc2FnZShtZXNzYWdlKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIC8vIFdlIG1heSBoYXZlIHF1ZXVlZCBtZXNzYWdlcyByZWNlaXZlZCBmcm9tIHRoZSBzaWduYWxpbmcgY2hhbm5lbCBiZWZvcmVcbiAgICAvLyBzdGFydGVkLlxuICAgIGlmICh0aGlzLm1lc3NhZ2VRdWV1ZS5sZW5ndGggPiAwKSB7XG4gICAgICB0aGlzLmRyYWluTWVzc2FnZVF1ZXVlKCk7XG4gICAgfVxuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgLyoqXG4gICAqIHNlbmQgYFBlZXJDb25uZWN0aW9uQ2xpZW50U2lnbmFsTWVzc2FnZVR5cGUuQnllYCBtZXNzYWdlIHRvIGNvbm5lY3RlZCB1c2VyIGFuZCBjbG9zZSB0aGUgb3BlbiBjb25uZWN0aW9uIFxuICAgKi9cbiAgcHVibGljIGNsb3NlKCk6IHZvaWQge1xuICAgIHRoaXMubG9nKCdjbG9zZScpO1xuICAgIGlmICghdGhpcy5jb25uZWN0aW9uKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMuc2lnbmFsaW5nTWVzc2FnZS5lbWl0KHtcbiAgICAgIHR5cGU6IFBlZXJDb25uZWN0aW9uQ2xpZW50U2lnbmFsTWVzc2FnZVR5cGUuQnllXG4gICAgfSk7XG4gICAgdGhpcy5jb25uZWN0aW9uLmNsb3NlKCk7XG4gICAgdGhpcy5jb25uZWN0aW9uID0gbnVsbDtcbiAgfVxuXG4gIC8qKlxuICAgKiBzZW5kIGBQZWVyQ29ubmVjdGlvbkNsaWVudFNpZ25hbE1lc3NhZ2VUeXBlLkF1ZGlvTXV0ZWRgIG1lc3NhZ2UgdG8gY29ubmVjdGVkIHVzZXJcbiAgICovXG4gIHB1YmxpYyBhdWRpb011dGVkKCk6IHZvaWQge1xuICAgIGlmICghdGhpcy5jb25uZWN0aW9uKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMuc2lnbmFsaW5nTWVzc2FnZS5lbWl0KHtcbiAgICAgIHR5cGU6IFBlZXJDb25uZWN0aW9uQ2xpZW50U2lnbmFsTWVzc2FnZVR5cGUuQXVkaW9NdXRlZFxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIHNlbmQgYFBlZXJDb25uZWN0aW9uQ2xpZW50U2lnbmFsTWVzc2FnZVR5cGUuQXVkaW9Vbm11dGVkYCBtZXNzYWdlIHRvIGNvbm5lY3RlZCB1c2VyXG4gICAqL1xuICBwdWJsaWMgYXVkaW9Vbm11dGVkKCk6IHZvaWQge1xuICAgIGlmICghdGhpcy5jb25uZWN0aW9uKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMuc2lnbmFsaW5nTWVzc2FnZS5lbWl0KHtcbiAgICAgIHR5cGU6IFBlZXJDb25uZWN0aW9uQ2xpZW50U2lnbmFsTWVzc2FnZVR5cGUuQXVkaW9Vbm11dGVkXG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogc2VuZCBgUGVlckNvbm5lY3Rpb25DbGllbnRTaWduYWxNZXNzYWdlVHlwZS5WaWRlb011dGVkYCBtZXNzYWdlIHRvIGNvbm5lY3RlZCB1c2VyXG4gICAqL1xuICBwdWJsaWMgdmlkZW9NdXRlZCgpOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMuY29ubmVjdGlvbikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLnNpZ25hbGluZ01lc3NhZ2UuZW1pdCh7XG4gICAgICB0eXBlOiBQZWVyQ29ubmVjdGlvbkNsaWVudFNpZ25hbE1lc3NhZ2VUeXBlLlZpZGVvTXV0ZWRcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBzZW5kIGBQZWVyQ29ubmVjdGlvbkNsaWVudFNpZ25hbE1lc3NhZ2VUeXBlLlZpZGVvVW5tdXRlZGAgbWVzc2FnZSB0byBjb25uZWN0ZWQgdXNlclxuICAgKi9cbiAgcHVibGljIHZpZGVvVW5tdXRlZCgpOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMuY29ubmVjdGlvbikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLnNpZ25hbGluZ01lc3NhZ2UuZW1pdCh7XG4gICAgICB0eXBlOiBQZWVyQ29ubmVjdGlvbkNsaWVudFNpZ25hbE1lc3NhZ2VUeXBlLlZpZGVvVW5tdXRlZFxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIHNlbmQgYFBlZXJDb25uZWN0aW9uQ2xpZW50U2lnbmFsTWVzc2FnZVR5cGUuUmVxdWVzdE11dGVBdWRpb2AgbWVzc2FnZSB0byBjb25uZWN0ZWQgdXNlclxuICAgKi9cbiAgcHVibGljIHJlcXVlc3RNdXRlQXVkaW8oKTogdm9pZCB7XG4gICAgdGhpcy5sb2coJ3JlcXVlc3RNdXRlQXVkaW8nKTtcbiAgICBpZiAoIXRoaXMuY29ubmVjdGlvbikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLnNpZ25hbGluZ01lc3NhZ2UuZW1pdCh7XG4gICAgICB0eXBlOiBQZWVyQ29ubmVjdGlvbkNsaWVudFNpZ25hbE1lc3NhZ2VUeXBlLlJlcXVlc3RNdXRlQXVkaW9cbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBzZW5kIGBQZWVyQ29ubmVjdGlvbkNsaWVudFNpZ25hbE1lc3NhZ2VUeXBlLlJlcXVlc3RNdXRlVmlkZW9gIG1lc3NhZ2UgdG8gY29ubmVjdGVkIHVzZXJcbiAgICovXG4gIHB1YmxpYyByZXF1ZXN0TXV0ZVZpZGVvKCk6IHZvaWQge1xuICAgIHRoaXMubG9nKCdyZXF1ZXN0TXV0ZVZpZGVvJyk7XG4gICAgaWYgKCF0aGlzLmNvbm5lY3Rpb24pIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5zaWduYWxpbmdNZXNzYWdlLmVtaXQoe1xuICAgICAgdHlwZTogUGVlckNvbm5lY3Rpb25DbGllbnRTaWduYWxNZXNzYWdlVHlwZS5SZXF1ZXN0TXV0ZVZpZGVvXG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogc2VuZCBgUGVlckNvbm5lY3Rpb25DbGllbnRTaWduYWxNZXNzYWdlVHlwZS5TdGFydFNoYXJlU2NyZWVuYCBtZXNzYWdlIHRvIGNvbm5lY3RlZCB1c2VyXG4gICAqL1xuICBwdWJsaWMgc3RhcnRTaGFyZVNjcmVlbigpOiB2b2lkIHtcbiAgICB0aGlzLmxvZygnc3RhcnRTaGFyZVNjcmVlbicpO1xuICAgIGlmICghdGhpcy5jb25uZWN0aW9uKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMuc2lnbmFsaW5nTWVzc2FnZS5lbWl0KHtcbiAgICAgIHR5cGU6IFBlZXJDb25uZWN0aW9uQ2xpZW50U2lnbmFsTWVzc2FnZVR5cGUuU3RhcnRTaGFyZVNjcmVlblxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIHNlbmQgYFBlZXJDb25uZWN0aW9uQ2xpZW50U2lnbmFsTWVzc2FnZVR5cGUuU3RvcFNoYXJlU2NyZWVuYCBtZXNzYWdlIHRvIGNvbm5lY3RlZCB1c2VyXG4gICAqL1xuICBwdWJsaWMgc3RvcFNoYXJlU2NyZWVuKCk6IHZvaWQge1xuICAgIHRoaXMubG9nKCdzdGFydFNoYXJlU2NyZWVuJyk7XG4gICAgaWYgKCF0aGlzLmNvbm5lY3Rpb24pIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5zaWduYWxpbmdNZXNzYWdlLmVtaXQoe1xuICAgICAgdHlwZTogUGVlckNvbm5lY3Rpb25DbGllbnRTaWduYWxNZXNzYWdlVHlwZS5TdG9wU2hhcmVTY3JlZW5cbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBnZXQgcGVlciBjb25uZWN0aW9uIHN0YXRlXG4gICAqIEByZXR1cm5zIGBudWxsYCBpZiBub3QgY29ubmVjdGVkIG90aGVyd2llc2UgYW4gb2JqZWN0IG9mIGBSVENTaWduYWxpbmdTdGF0ZWAsIGBSVENJY2VHYXRoZXJpbmdTdGF0ZWAgYW5kIGBSVENJY2VDb25uZWN0aW9uU3RhdGVgXG4gICAqL1xuICBwdWJsaWMgZ2V0UGVlckNvbm5lY3Rpb25TdGF0ZXMoKToge1xuICAgIHNpZ25hbGluZ1N0YXRlOiBSVENTaWduYWxpbmdTdGF0ZSxcbiAgICBpY2VHYXRoZXJpbmdTdGF0ZTogUlRDSWNlR2F0aGVyaW5nU3RhdGUsXG4gICAgaWNlQ29ubmVjdGlvblN0YXRlOiBSVENJY2VDb25uZWN0aW9uU3RhdGVcbiAgfSB8IG51bGwge1xuICAgIGlmICghdGhpcy5jb25uZWN0aW9uKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgcmV0dXJuIHtcbiAgICAgIHNpZ25hbGluZ1N0YXRlOiB0aGlzLmNvbm5lY3Rpb24uc2lnbmFsaW5nU3RhdGUsXG4gICAgICBpY2VHYXRoZXJpbmdTdGF0ZTogdGhpcy5jb25uZWN0aW9uLmljZUdhdGhlcmluZ1N0YXRlLFxuICAgICAgaWNlQ29ubmVjdGlvblN0YXRlOiB0aGlzLmNvbm5lY3Rpb24uaWNlQ29ubmVjdGlvblN0YXRlXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBnZXQgdGhlIGNvbm5lY3Rpb24gc3RhdHMgb2YgYSB0cmFjayBpbiB0aGUgY29ubmVjdGlvbiBcbiAgICogQHBhcmFtIHRyYWNrIGBNZWRpYVN0cmVhbVRyYWNrYCB0byBjaGVjayBzdGF0ZSBmb3JcbiAgICogQHJldHVybnMgUHJvbWlzZSB0aGF0IHJlc29sdmVzIHRvIGBSVENTdGF0c1JlcG9ydGBcbiAgICovXG4gIHB1YmxpYyBnZXRQZWVyQ29ubmVjdGlvblN0YXRzKHRyYWNrPzogTWVkaWFTdHJlYW1UcmFjayk6IFByb21pc2U8UlRDU3RhdHNSZXBvcnQ+IHtcbiAgICBpZiAoIXRoaXMuY29ubmVjdGlvbikge1xuICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KCk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLmNvbm5lY3Rpb24uZ2V0U3RhdHModHJhY2spO1xuICB9XG5cbiAgLyoqXG4gICAqIGFkZCBhIGBNZWRpYVN0cmVhbVRyYWNrYCB0byB0aGUgY29ubmVjdGlvblxuICAgKiBAcGFyYW0gdHJhY2sgYE1lZGlhU3RyZWFtVHJhY2tgIHRvIGJlIGFkZGVkIHRvIHRoZSBjb25uZWN0aW9uLlxuICAgKi9cbiAgcHVibGljIGFkZFRyYWNrKHRyYWNrOiBNZWRpYVN0cmVhbVRyYWNrKTogdm9pZCB7XG4gICAgdGhpcy5sb2coJ2FkZFRyYWNrJywgdHJhY2spO1xuICAgIGlmICh0aGlzLmNvbm5lY3Rpb24pIHtcbiAgICAgIGNvbnN0IHNlbmRlciA9IHRoaXMuY29ubmVjdGlvbi5nZXRTZW5kZXJzKCkuZmluZCgocykgPT4ge1xuICAgICAgICByZXR1cm4gcz8udHJhY2s/LmtpbmQgPT09IHRyYWNrLmtpbmQ7XG4gICAgICB9KTtcbiAgICAgIGlmIChzZW5kZXI/LnRyYWNrKSB7XG4gICAgICAgIHRoaXMubG9nKCdleGlzdGluZyB0cmFjayBmb3VuZCB1c2luZyByZXBsYWNlVHJhY2sgaW5zdGVhZCcpO1xuICAgICAgICB0aGlzLnJlcGxhY2VUcmFjayh0cmFjayk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLmNvbm5lY3Rpb24uYWRkVHJhY2sodHJhY2spO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiByZXBsYWNlIGN1cnJlbnQgYE1lZGlhU3RyZWFtVHJhY2tgIHdpdGggbmV3IGZyb20gcGFyYW1ldGVyXG4gICAqIEBwYXJhbSB0cmFjayBuZXcgYE1lZGlhU3RyZWFtVHJhY2tgXG4gICAqL1xuICBwdWJsaWMgcmVwbGFjZVRyYWNrKHRyYWNrOiBNZWRpYVN0cmVhbVRyYWNrKTogdm9pZCB7XG4gICAgdGhpcy5sb2codHJhY2spO1xuICAgIGlmICh0aGlzLmNvbm5lY3Rpb24pIHtcbiAgICAgIGNvbnN0IHNlbmRlciA9IHRoaXMuY29ubmVjdGlvbi5nZXRTZW5kZXJzKCkuZmluZCgocykgPT4ge1xuICAgICAgICByZXR1cm4gcz8udHJhY2s/LmtpbmQgPT09IHRyYWNrLmtpbmQ7XG4gICAgICB9KTtcbiAgICAgIGlmICghc2VuZGVyPy50cmFjaykge1xuICAgICAgICB0aGlzLmxvZygnbm8gdHJhY2sgZm91bmQgdXNpbmcgYWRkVHJhY2sgaW5zdGVhZCcpO1xuICAgICAgICB0aGlzLmFkZFRyYWNrKHRyYWNrKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHNlbmRlci5yZXBsYWNlVHJhY2sodHJhY2spO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBBZGQgYWxsIGBNZWRpYVN0cmVhbVRyYWNrYHMgb2YgYSBgTWVkaWFTdHJlYW1gIHRvIHRoZSBjb25uZWN0aW9uXG4gICAqIEBwYXJhbSBtZWRpYVN0ZWFtIGBNZWRpYVN0cmVhbWAgd2l0aCB0cmFja3NcbiAgICovXG4gIHB1YmxpYyBhZGRTdHJlYW0obWVkaWFTdGVhbTogTWVkaWFTdHJlYW0pOiB2b2lkIHtcbiAgICB0aGlzLmxvZygnYWRkU3RyZWFtJywgbWVkaWFTdGVhbSk7XG4gICAgbWVkaWFTdGVhbS5nZXRUcmFja3MoKS5mb3JFYWNoKHRyYWNrID0+IHtcbiAgICAgIHRoaXMuYWRkVHJhY2sodHJhY2spO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBzZXRMb2NhbFNkcEFuZE5vdGlmeShzZXNzaW9uRGVzY3JpcHRpb246IFJUQ1Nlc3Npb25EZXNjcmlwdGlvbkluaXQpOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMuY29ubmVjdGlvbikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICAvLyB0aGlzLmxvZygnc2V0TG9jYWxTZHBBbmROb3RpZnknLCBzZXNzaW9uRGVzY3JpcHRpb24pO1xuICAgIGlmIChzZXNzaW9uRGVzY3JpcHRpb24uc2RwKSB7XG4gICAgICBzZXNzaW9uRGVzY3JpcHRpb24uc2RwID0gU2RwVXRpbHMubWF5YmVTZXRPcHVzT3B0aW9ucyhzZXNzaW9uRGVzY3JpcHRpb24uc2RwLCB0aGlzLnNldHRpbmdzKTtcbiAgICAgIHNlc3Npb25EZXNjcmlwdGlvbi5zZHAgPSBTZHBVdGlscy5tYXliZVByZWZlckF1ZGlvUmVjZWl2ZUNvZGVjKHNlc3Npb25EZXNjcmlwdGlvbi5zZHAsIHRoaXMuc2V0dGluZ3MpO1xuICAgICAgc2Vzc2lvbkRlc2NyaXB0aW9uLnNkcCA9IFNkcFV0aWxzLm1heWJlUHJlZmVyVmlkZW9SZWNlaXZlQ29kZWMoc2Vzc2lvbkRlc2NyaXB0aW9uLnNkcCwgdGhpcy5zZXR0aW5ncyk7XG4gICAgICBzZXNzaW9uRGVzY3JpcHRpb24uc2RwID0gU2RwVXRpbHMubWF5YmVTZXRBdWRpb1JlY2VpdmVCaXRSYXRlKHNlc3Npb25EZXNjcmlwdGlvbi5zZHAsIHRoaXMuc2V0dGluZ3MpO1xuICAgICAgc2Vzc2lvbkRlc2NyaXB0aW9uLnNkcCA9IFNkcFV0aWxzLm1heWJlU2V0VmlkZW9SZWNlaXZlQml0UmF0ZShzZXNzaW9uRGVzY3JpcHRpb24uc2RwLCB0aGlzLnNldHRpbmdzKTtcbiAgICAgIHNlc3Npb25EZXNjcmlwdGlvbi5zZHAgPSBTZHBVdGlscy5tYXliZVJlbW92ZVZpZGVvRmVjKHNlc3Npb25EZXNjcmlwdGlvbi5zZHAsIHRoaXMuc2V0dGluZ3MpO1xuICAgIH1cbiAgICB0aGlzLmNvbm5lY3Rpb24uc2V0TG9jYWxEZXNjcmlwdGlvbihzZXNzaW9uRGVzY3JpcHRpb24pXG4gICAgICAgIC50aGVuKCgpID0+IHRoaXMubG9nKCdTZXQgc2Vzc2lvbiBkZXNjcmlwdGlvbiBzdWNjZXNzLicpKVxuICAgICAgICAuY2F0Y2godGhpcy5vbkVycm9yLmJpbmQodGhpcywgJ3NldExvY2FsRGVzY3JpcHRpb24nKSk7XG5cbiAgICAvLyBDaHJvbWUgdmVyc2lvbiBvZiBSVENTZXNzaW9uRGVzY3JpcHRpb24gY2FuJ3QgYmUgc2VyaWFsaXplZCBkaXJlY3RseVxuICAgIC8vIGJlY2F1c2UgaXQgSlNPTi5zdHJpbmdpZnkgd29uJ3QgaW5jbHVkZSBhdHRyaWJ1dGVzIHdoaWNoIGFyZSBvbiB0aGVcbiAgICAvLyBvYmplY3QncyBwcm90b3R5cGUgY2hhaW4uIEJ5IGNyZWF0aW5nIHRoZSBtZXNzYWdlIHRvIHNlcmlhbGl6ZVxuICAgIC8vIGV4cGxpY2l0bHkgd2UgY2FuIGF2b2lkIHRoZSBpc3N1ZS5cbiAgICB0aGlzLnNpZ25hbGluZ01lc3NhZ2UuZW1pdCh7XG4gICAgICBzZHA6IHNlc3Npb25EZXNjcmlwdGlvbi5zZHAsXG4gICAgICB0eXBlOiBzZXNzaW9uRGVzY3JpcHRpb24udHlwZVxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBmaWx0ZXJJY2VDYW5kaWRhdGUoY2FuZGlkYXRlT2JqOiBSVENJY2VDYW5kaWRhdGUpOiBib29sZWFuIHtcbiAgICAvLyB0aGlzLmxvZygnZmlsdGVySWNlQ2FuZGlkYXRlJywgY2FuZGlkYXRlT2JqKTtcbiAgICBjb25zdCBjYW5kaWRhdGVTdHIgPSBjYW5kaWRhdGVPYmouY2FuZGlkYXRlO1xuXG4gICAgLy8gQWx3YXlzIHJlbW92ZSBUQ1AgY2FuZGlkYXRlcy4gTm90IG5lZWRlZCBpbiB0aGlzIGNvbnRleHQuXG4gICAgaWYgKGNhbmRpZGF0ZVN0ci5pbmRleE9mKCd0Y3AnKSAhPT0gLTEpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICAvLyBJZiB3ZSdyZSB0cnlpbmcgdG8gcmVtb3ZlIG5vbi1yZWxheSBjYW5kaWRhdGVzLCBkbyB0aGF0LlxuICAgIGlmICh0aGlzLnNldHRpbmdzLnBlZXJDb25uZWN0aW9uQ29uZmlnLmljZVRyYW5zcG9ydHMgPT09ICdyZWxheScgJiYgU2RwVXRpbHMuaWNlQ2FuZGlkYXRlVHlwZShjYW5kaWRhdGVTdHIpICE9PSAncmVsYXknKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBwcml2YXRlIG9uSWNlQ2FuZGlkYXRlKGV2ZW50OiBSVENQZWVyQ29ubmVjdGlvbkljZUV2ZW50KTogdm9pZCB7XG4gICAgLy8gdGhpcy5sb2coJ29uSWNlQ2FuZGlkYXRlJywgZXZlbnQpO1xuICAgIGlmIChldmVudC5jYW5kaWRhdGUpIHtcbiAgICAgIC8vIEVhdCB1bmRlc2lyZWQgY2FuZGlkYXRlcy5cbiAgICAgIGlmICh0aGlzLmZpbHRlckljZUNhbmRpZGF0ZShldmVudC5jYW5kaWRhdGUpKSB7XG4gICAgICAgIGNvbnN0IG1lc3NhZ2UgPSB7XG4gICAgICAgICAgdHlwZTogUGVlckNvbm5lY3Rpb25DbGllbnRTaWduYWxNZXNzYWdlVHlwZS5DYW5kaWRhdGUsXG4gICAgICAgICAgbGFiZWw6IGV2ZW50LmNhbmRpZGF0ZS5zZHBNTGluZUluZGV4LFxuICAgICAgICAgIGlkOiBldmVudC5jYW5kaWRhdGUuc2RwTWlkLFxuICAgICAgICAgIGNhbmRpZGF0ZTogZXZlbnQuY2FuZGlkYXRlLmNhbmRpZGF0ZVxuICAgICAgICB9O1xuICAgICAgICB0aGlzLnNpZ25hbGluZ01lc3NhZ2UuZW1pdChtZXNzYWdlKTtcbiAgICAgICAgdGhpcy5vblJlY29yZEljZUNhbmRpZGF0ZSgnTG9jYWwnLCBldmVudC5jYW5kaWRhdGUpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmxvZygnRW5kIG9mIGNhbmRpZGF0ZXMuJyk7XG4gICAgfVxuICB9XG5cblxuICBwcml2YXRlIGhhbmRsZU1lc3NhZ2VFdmVudHMobWVzc2FnZU9iajogUGVlckNvbm5lY3Rpb25DbGllbnRTaWduYWxNZXNzYWdlKTogdm9pZCB7XG4gICAgaWYgKG1lc3NhZ2VPYmoudHlwZSA9PT0gUGVlckNvbm5lY3Rpb25DbGllbnRTaWduYWxNZXNzYWdlVHlwZS5CeWUpIHtcbiAgICAgIHRoaXMucmVtb3RlSGFuZ1VwLmVtaXQoKTtcbiAgICB9IGVsc2UgaWYgKG1lc3NhZ2VPYmoudHlwZSA9PT0gUGVlckNvbm5lY3Rpb25DbGllbnRTaWduYWxNZXNzYWdlVHlwZS5SZXF1ZXN0TXV0ZUF1ZGlvKSB7XG4gICAgICB0aGlzLm11dGVNeUF1ZGlvLmVtaXQoKTtcbiAgICB9IGVsc2UgaWYgKG1lc3NhZ2VPYmoudHlwZSA9PT0gUGVlckNvbm5lY3Rpb25DbGllbnRTaWduYWxNZXNzYWdlVHlwZS5SZXF1ZXN0TXV0ZVZpZGVvKSB7XG4gICAgICB0aGlzLm11dGVNeVZpZGVvLmVtaXQoKTtcbiAgICB9IGVsc2UgaWYgKG1lc3NhZ2VPYmoudHlwZSA9PT0gUGVlckNvbm5lY3Rpb25DbGllbnRTaWduYWxNZXNzYWdlVHlwZS5BdWRpb011dGVkKSB7XG4gICAgICB0aGlzLnVzZXJNdXRlQXVkaW8uZW1pdCgpO1xuICAgIH0gZWxzZSBpZiAobWVzc2FnZU9iai50eXBlID09PSBQZWVyQ29ubmVjdGlvbkNsaWVudFNpZ25hbE1lc3NhZ2VUeXBlLkF1ZGlvVW5tdXRlZCkge1xuICAgICAgdGhpcy51c2VyVW5tdXRlQXVkaW8uZW1pdCgpO1xuICAgIH0gZWxzZSBpZiAobWVzc2FnZU9iai50eXBlID09PSBQZWVyQ29ubmVjdGlvbkNsaWVudFNpZ25hbE1lc3NhZ2VUeXBlLlZpZGVvTXV0ZWQpIHtcbiAgICAgIHRoaXMudXNlck11dGVWaWRlby5lbWl0KCk7XG4gICAgfSAgZWxzZSBpZiAobWVzc2FnZU9iai50eXBlID09PSBQZWVyQ29ubmVjdGlvbkNsaWVudFNpZ25hbE1lc3NhZ2VUeXBlLlZpZGVvVW5tdXRlZCkge1xuICAgICAgdGhpcy51c2VyVW5tdXRlVmlkZW8uZW1pdCgpO1xuICAgIH0gZWxzZSBpZiAobWVzc2FnZU9iai50eXBlID09PSBQZWVyQ29ubmVjdGlvbkNsaWVudFNpZ25hbE1lc3NhZ2VUeXBlLlN0YXJ0U2hhcmVTY3JlZW4pIHtcbiAgICAgIHRoaXMudXNlU2hhcmVTY3JlZW4kLm5leHQodHJ1ZSk7XG4gICAgfSBlbHNlIGlmIChtZXNzYWdlT2JqLnR5cGUgPT09IFBlZXJDb25uZWN0aW9uQ2xpZW50U2lnbmFsTWVzc2FnZVR5cGUuU3RvcFNoYXJlU2NyZWVuKSB7XG4gICAgICB0aGlzLnVzZVNoYXJlU2NyZWVuJC5uZXh0KGZhbHNlKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogZXhlY3V0ZSB0aGlzIG1ldGhvZGUgdG8gc2V0IG1lc3NhZ2VzIGluIHRoZSBwZWVyIGNvbm5lY3Rpb24uIFlvdSBuZWVkIGEgY29ubmVjdGlvbiBsYXkgdG8gcmVjZWl2ZSBtZXNzYWdlcy5cbiAgICogQHBhcmFtIG1lc3NhZ2UgbWVzc2FnZSB0byBwcm9jZXNzXG4gICAqL1xuICBwdWJsaWMgcmVjZWl2ZVNpZ25hbGluZ01lc3NhZ2UobWVzc2FnZTogc3RyaW5nIHwgUGVlckNvbm5lY3Rpb25DbGllbnRTaWduYWxNZXNzYWdlKTogdm9pZCB7XG4gICAgdGhpcy5sb2coJ3JlY2VpdmVTaWduYWxpbmdNZXNzYWdlJywgbWVzc2FnZSk7XG4gICAgbGV0IG1lc3NhZ2VPYmo6IFBlZXJDb25uZWN0aW9uQ2xpZW50U2lnbmFsTWVzc2FnZTtcbiAgICBpZiAodHlwZW9mIG1lc3NhZ2UgPT09ICdzdHJpbmcnKSB7XG4gICAgICB0cnkge1xuICAgICAgICBtZXNzYWdlT2JqID0gSlNPTi5wYXJzZShtZXNzYWdlKTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIHRoaXMubG9nKCdpbnZhbGlkIGpzb24gZm9yIG1lc3NhZ2UnLCBtZXNzYWdlKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBtZXNzYWdlT2JqID0gbWVzc2FnZTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5jb25uZWN0aW9uPy5pY2VHYXRoZXJpbmdTdGF0ZSA9PT0gJ2NvbXBsZXRlJyB8fFxuICAgICAgKCh0aGlzLmlzSW5pdGlhdG9yICYmIG1lc3NhZ2VPYmoudHlwZSA9PT0gUGVlckNvbm5lY3Rpb25DbGllbnRTaWduYWxNZXNzYWdlVHlwZS5BbnN3ZXIpIHx8XG4gICAgICAgICghdGhpcy5pc0luaXRpYXRvciAmJiBtZXNzYWdlT2JqLnR5cGUgPT09IFBlZXJDb25uZWN0aW9uQ2xpZW50U2lnbmFsTWVzc2FnZVR5cGUuT2ZmZXIpKSkge1xuICAgICAgdGhpcy5oYXNSZW1vdGVTZHAgPSB0cnVlO1xuICAgICAgLy8gQWx3YXlzIHByb2Nlc3Mgb2ZmZXIgYmVmb3JlIGNhbmRpZGF0ZXMuXG4gICAgICB0aGlzLm1lc3NhZ2VRdWV1ZS51bnNoaWZ0KG1lc3NhZ2VPYmopO1xuICAgIH1cblxuICAgIGlmIChtZXNzYWdlT2JqLnR5cGUgPT09IFBlZXJDb25uZWN0aW9uQ2xpZW50U2lnbmFsTWVzc2FnZVR5cGUuQ2FuZGlkYXRlKSB7XG4gICAgICB0aGlzLm1lc3NhZ2VRdWV1ZS5wdXNoKG1lc3NhZ2VPYmopO1xuICAgIH1cbiAgICB0aGlzLmhhbmRsZU1lc3NhZ2VFdmVudHMobWVzc2FnZU9iaik7XG4gICAgdGhpcy5kcmFpbk1lc3NhZ2VRdWV1ZSgpO1xuICB9XG5cblxuICBwcml2YXRlIHByb2Nlc3NTaWduYWxpbmdNZXNzYWdlKG1lc3NhZ2U6IFBlZXJDb25uZWN0aW9uQ2xpZW50U2lnbmFsTWVzc2FnZSk6IHZvaWQge1xuICAgIHRoaXMubG9nKCdwcm9jZXNzU2lnbmFsaW5nTWVzc2FnZScsIG1lc3NhZ2UpO1xuICAgIGlmICghdGhpcy5jb25uZWN0aW9uKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMuaGFuZGxlTWVzc2FnZUV2ZW50cyhtZXNzYWdlKTtcbiAgICBpZiAobWVzc2FnZS50eXBlID09PSBQZWVyQ29ubmVjdGlvbkNsaWVudFNpZ25hbE1lc3NhZ2VUeXBlLk9mZmVyICYmICghdGhpcy5pc0luaXRpYXRvciB8fCB0aGlzLmNvbm5lY3Rpb24uaWNlR2F0aGVyaW5nU3RhdGUgPT09ICdjb21wbGV0ZScpKSB7XG4gICAgICBpZiAodGhpcy5jb25uZWN0aW9uLnNpZ25hbGluZ1N0YXRlICE9PSAnc3RhYmxlJykge1xuICAgICAgICB0aGlzLmxvZygnRVJST1I6IHJlbW90ZSBvZmZlciByZWNlaXZlZCBpbiB1bmV4cGVjdGVkIHN0YXRlOiAnICsgdGhpcy5jb25uZWN0aW9uLnNpZ25hbGluZ1N0YXRlKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgdGhpcy5zZXRSZW1vdGVTZHAobWVzc2FnZSk7XG4gICAgICB0aGlzLmRvQW5zd2VyKCk7XG4gICAgfSBlbHNlIGlmIChtZXNzYWdlLnR5cGUgPT09IFBlZXJDb25uZWN0aW9uQ2xpZW50U2lnbmFsTWVzc2FnZVR5cGUuQW5zd2VyICYmICh0aGlzLmlzSW5pdGlhdG9yIHx8IHRoaXMuY29ubmVjdGlvbi5pY2VHYXRoZXJpbmdTdGF0ZSA9PT0gJ2NvbXBsZXRlJykpIHtcbiAgICAgIGlmICh0aGlzLmNvbm5lY3Rpb24uc2lnbmFsaW5nU3RhdGUgIT09ICdoYXZlLWxvY2FsLW9mZmVyJykge1xuICAgICAgICB0aGlzLmxvZygnRVJST1I6IHJlbW90ZSBhbnN3ZXIgcmVjZWl2ZWQgaW4gdW5leHBlY3RlZCBzdGF0ZTogJyArXG4gICAgICAgICAgICAgIHRoaXMuY29ubmVjdGlvbi5zaWduYWxpbmdTdGF0ZSk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIHRoaXMuc2V0UmVtb3RlU2RwKG1lc3NhZ2UpO1xuICAgIH0gZWxzZSBpZiAobWVzc2FnZS50eXBlID09PSBQZWVyQ29ubmVjdGlvbkNsaWVudFNpZ25hbE1lc3NhZ2VUeXBlLkNhbmRpZGF0ZSkge1xuICAgICAgY29uc3QgY2FuZGlkYXRlID0gbmV3IFJUQ0ljZUNhbmRpZGF0ZSh7XG4gICAgICAgIHNkcE1MaW5lSW5kZXg6IG1lc3NhZ2UubGFiZWwsXG4gICAgICAgIGNhbmRpZGF0ZTogbWVzc2FnZS5jYW5kaWRhdGVcbiAgICAgIH0pO1xuICAgICAgdGhpcy5vblJlY29yZEljZUNhbmRpZGF0ZSgnUmVtb3RlJywgY2FuZGlkYXRlKTtcbiAgICAgIHRoaXMuY29ubmVjdGlvbi5hZGRJY2VDYW5kaWRhdGUoY2FuZGlkYXRlKVxuICAgICAgICAgIC50aGVuKHRoaXMubG9nLmJpbmQodGhpcywgJ1JlbW90ZSBjYW5kaWRhdGUgYWRkZWQgc3VjY2Vzc2Z1bGx5LicpKVxuICAgICAgICAgIC5jYXRjaCh0aGlzLm9uRXJyb3IuYmluZCh0aGlzLCAnYWRkSWNlQ2FuZGlkYXRlJykpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmxvZyhgV0FSTklORzogdW5leHBlY3RlZCBtZXNzYWdlOiAke21lc3NhZ2UudHlwZX1gKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGRvQW5zd2VyKCk6IHZvaWQge1xuICAgIGlmICghdGhpcy5jb25uZWN0aW9uKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMubG9nKCdTZW5kaW5nIGFuc3dlciB0byBwZWVyLicpO1xuICAgIHRoaXMuY29ubmVjdGlvbi5jcmVhdGVBbnN3ZXIoKVxuICAgICAgICAudGhlbih0aGlzLnNldExvY2FsU2RwQW5kTm90aWZ5LmJpbmQodGhpcykpXG4gICAgICAgIC5jYXRjaCh0aGlzLm9uRXJyb3IuYmluZCh0aGlzLCAnY3JlYXRlQW5zd2VyJykpO1xuICB9XG5cblxuICBwcml2YXRlIHNldFJlbW90ZVNkcChtZXNzYWdlOiBQZWVyQ29ubmVjdGlvbkNsaWVudFNpZ25hbE1lc3NhZ2UpOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMuY29ubmVjdGlvbikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICAvLyB0aGlzLmxvZygnc2V0UmVtb3RlU2RwJywgbWVzc2FnZSk7XG4gICAgaWYgKG1lc3NhZ2Uuc2RwKSB7XG4gICAgICBtZXNzYWdlLnNkcCA9IFNkcFV0aWxzLm1heWJlU2V0T3B1c09wdGlvbnMobWVzc2FnZS5zZHAsIHRoaXMuc2V0dGluZ3MpO1xuICAgICAgbWVzc2FnZS5zZHAgPSBTZHBVdGlscy5tYXliZVByZWZlckF1ZGlvU2VuZENvZGVjKG1lc3NhZ2Uuc2RwLCB0aGlzLnNldHRpbmdzKTtcbiAgICAgIG1lc3NhZ2Uuc2RwID0gU2RwVXRpbHMubWF5YmVQcmVmZXJWaWRlb1NlbmRDb2RlYyhtZXNzYWdlLnNkcCwgdGhpcy5zZXR0aW5ncyk7XG4gICAgICBtZXNzYWdlLnNkcCA9IFNkcFV0aWxzLm1heWJlU2V0QXVkaW9TZW5kQml0UmF0ZShtZXNzYWdlLnNkcCwgdGhpcy5zZXR0aW5ncyk7XG4gICAgICBtZXNzYWdlLnNkcCA9IFNkcFV0aWxzLm1heWJlU2V0VmlkZW9TZW5kQml0UmF0ZShtZXNzYWdlLnNkcCwgdGhpcy5zZXR0aW5ncyk7XG4gICAgICBtZXNzYWdlLnNkcCA9IFNkcFV0aWxzLm1heWJlU2V0VmlkZW9TZW5kSW5pdGlhbEJpdFJhdGUobWVzc2FnZS5zZHAsIHRoaXMuc2V0dGluZ3MpO1xuICAgICAgbWVzc2FnZS5zZHAgPSBTZHBVdGlscy5tYXliZVJlbW92ZVZpZGVvRmVjKG1lc3NhZ2Uuc2RwLCB0aGlzLnNldHRpbmdzKTtcbiAgICB9XG4gICAgdGhpcy5jb25uZWN0aW9uLnNldFJlbW90ZURlc2NyaXB0aW9uKG5ldyBSVENTZXNzaW9uRGVzY3JpcHRpb24obWVzc2FnZSBhcyBSVENTZXNzaW9uRGVzY3JpcHRpb25Jbml0KSlcbiAgICAgICAgLnRoZW4odGhpcy5vblNldFJlbW90ZURlc2NyaXB0aW9uU3VjY2Vzcy5iaW5kKHRoaXMpKVxuICAgICAgICAuY2F0Y2godGhpcy5vbkVycm9yLmJpbmQodGhpcywgJ3NldFJlbW90ZURlc2NyaXB0aW9uJykpO1xuICB9XG5cbiAgLy8gV2hlbiB3ZSByZWNlaXZlIG1lc3NhZ2VzIGZyb20gR0FFIHJlZ2lzdHJhdGlvbiBhbmQgZnJvbSB0aGUgV1NTIGNvbm5lY3Rpb24sXG4gIC8vIHdlIGFkZCB0aGVtIHRvIGEgcXVldWUgYW5kIGRyYWluIGl0IGlmIGNvbmRpdGlvbnMgYXJlIHJpZ2h0LlxuICBwcml2YXRlIGRyYWluTWVzc2FnZVF1ZXVlKCk6IHZvaWQge1xuICAgIC8vIEl0J3MgcG9zc2libGUgdGhhdCB3ZSBmaW5pc2ggcmVnaXN0ZXJpbmcgYW5kIHJlY2VpdmluZyBtZXNzYWdlcyBmcm9tIFdTU1xuICAgIC8vIGJlZm9yZSBvdXIgcGVlciBjb25uZWN0aW9uIGlzIGNyZWF0ZWQgb3Igc3RhcnRlZC4gV2UgbmVlZCB0byB3YWl0IGZvciB0aGVcbiAgICAvLyBwZWVyIGNvbm5lY3Rpb24gdG8gYmUgY3JlYXRlZCBhbmQgc3RhcnRlZCBiZWZvcmUgcHJvY2Vzc2luZyBtZXNzYWdlcy5cbiAgICAvL1xuICAgIC8vIEFsc28sIHRoZSBvcmRlciBvZiBtZXNzYWdlcyBpcyBpbiBnZW5lcmFsIG5vdCB0aGUgc2FtZSBhcyB0aGUgUE9TVCBvcmRlclxuICAgIC8vIGZyb20gdGhlIG90aGVyIGNsaWVudCBiZWNhdXNlIHRoZSBQT1NUcyBhcmUgYXN5bmMgYW5kIHRoZSBzZXJ2ZXIgbWF5IGhhbmRsZVxuICAgIC8vIHNvbWUgcmVxdWVzdHMgZmFzdGVyIHRoYW4gb3RoZXJzLiBXZSBuZWVkIHRvIHByb2Nlc3Mgb2ZmZXIgYmVmb3JlXG4gICAgLy8gY2FuZGlkYXRlcyBzbyB3ZSB3YWl0IGZvciB0aGUgb2ZmZXIgdG8gYXJyaXZlIGZpcnN0IGlmIHdlJ3JlIGFuc3dlcmluZy5cbiAgICAvLyBPZmZlcnMgYXJlIGFkZGVkIHRvIHRoZSBmcm9udCBvZiB0aGUgcXVldWUuXG4gICAgaWYgKCF0aGlzLmNvbm5lY3Rpb24gfHwgIXRoaXMuc3RhcnRlZCB8fCAhdGhpcy5oYXNSZW1vdGVTZHApIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgZm9yIChjb25zdCBtZXNzYWdlIG9mIHRoaXMubWVzc2FnZVF1ZXVlKSB7XG4gICAgICB0aGlzLnByb2Nlc3NTaWduYWxpbmdNZXNzYWdlKG1lc3NhZ2UpO1xuICAgIH1cbiAgICB0aGlzLm1lc3NhZ2VRdWV1ZSA9IFtdO1xuICB9XG5cblxuICAvLyBIb29rc1xuXG4gIHByaXZhdGUgb25JY2VDb25uZWN0aW9uU3RhdGVDaGFuZ2UoKTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLmNvbm5lY3Rpb24pIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5sb2coJ0lDRSBjb25uZWN0aW9uIHN0YXRlIGNoYW5nZWQgdG86ICcgKyB0aGlzLmNvbm5lY3Rpb24uaWNlQ29ubmVjdGlvblN0YXRlKTtcblxuICAgIGlmICh0aGlzLmNvbm5lY3Rpb24uaWNlQ29ubmVjdGlvblN0YXRlID09PSAnY29tcGxldGVkJykge1xuICAgICAgdGhpcy5sb2coJ0lDRSBjb21wbGV0ZSB0aW1lOiAnICtcbiAgICAgICAgICAod2luZG93LnBlcmZvcm1hbmNlLm5vdygpIC0gdGhpcy5zdGFydFRpbWUpLnRvRml4ZWQoMCkgKyAnbXMuJyk7XG4gICAgfVxuXG4gICAgdGhpcy5pY2VDb25uZWN0aW9uU3RhdGUkLm5leHQodGhpcy5jb25uZWN0aW9uLmljZUNvbm5lY3Rpb25TdGF0ZSk7XG4gIH1cblxuICBwcml2YXRlIG9ubmVnb3RpYXRpb25uZWVkZWQoKTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLmNvbm5lY3Rpb24pIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5sb2coJ29ubmVnb3RpYXRpb25uZWVkZWQnKTtcbiAgICB0aGlzLm5lZ290aWF0aW9uTmVlZGVkVHJpZ2dlcmVkLm5leHQodHJ1ZSk7XG5cbiAgfVxuXG4gIHByaXZhdGUgb25TaWduYWxpbmdTdGF0ZUNoYW5nZSgpOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMuY29ubmVjdGlvbikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLmlzTmVnb3RpYXRpbmcgPSAodGhpcy5jb25uZWN0aW9uLnNpZ25hbGluZ1N0YXRlICE9PSAnc3RhYmxlJyk7XG4gICAgdGhpcy5sb2coJ1NpZ25hbGluZyBzdGF0ZSBjaGFuZ2VkIHRvOiAnICsgdGhpcy5jb25uZWN0aW9uLnNpZ25hbGluZ1N0YXRlKTtcbiAgICB0aGlzLnNpZ25hbFN0YXRlJC5uZXh0KHRoaXMuY29ubmVjdGlvbi5zaWduYWxpbmdTdGF0ZSk7XG4gIH1cblxuICBwcml2YXRlIG9uRXJyb3Ioc291cmNlOiBzdHJpbmcsIGVycm9yPzogRXJyb3IpOiB2b2lkIHtcbiAgICB0aGlzLmxvZyhgJHtzb3VyY2V9OmAsIGVycm9yKTtcbiAgICB0aGlzLmVycm9yJC5uZXh0KHtzb3VyY2UsIGVycm9yfSk7XG4gIH1cblxuICBwcml2YXRlIG9uUmVjb3JkSWNlQ2FuZGlkYXRlKGxvY2F0aW9uOiBzdHJpbmcsIGNhbmRpZGF0ZU9iajogUlRDUGVlckNvbm5lY3Rpb25JY2VFdmVudFsnY2FuZGlkYXRlJ10pOiB2b2lkIHtcbiAgICBpZiAoY2FuZGlkYXRlT2JqPy5jYW5kaWRhdGUpIHtcbiAgICAgIHRoaXMuc2VlTmV3Q2FuZGlkYXRlJC5uZXh0KHtsb2NhdGlvbiwgY2FuZGlkYXRlOiBjYW5kaWRhdGVPYmouY2FuZGlkYXRlfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMubG9nKCdzZWUgbmV3IGNhbmRpZGF0ZSBidXQgY2FuZGlkYXRlIGlzIG51bGwnLCB7bG9jYXRpb24sIGNhbmRpZGF0ZTogY2FuZGlkYXRlT2JqfSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBvblJlbW90ZVRyYWNrQWRkZWQoZXZlbnQ6IFJUQ1RyYWNrRXZlbnQpOiB2b2lkIHtcbiAgICB0aGlzLnJlbW90ZVN0cmVhbUFkZGVkLmVtaXQoe1xuICAgICAgdHJhY2s6IGV2ZW50LnRyYWNrLFxuICAgICAga2luZDogZXZlbnQudHJhY2sua2luZCBhcyBTdHJlYW1UeXBlXG4gICAgfSk7XG4gICAgdGhpcy5yZW1vdGVUcmFja0FkZGVkLmVtaXQoe1xuICAgICAgdHJhY2s6IGV2ZW50LnRyYWNrLFxuICAgICAga2luZDogZXZlbnQudHJhY2sua2luZCBhcyBTdHJlYW1UeXBlXG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIG9uU2V0UmVtb3RlRGVzY3JpcHRpb25TdWNjZXNzKCk6IHZvaWQge1xuICAgIGlmICghdGhpcy5jb25uZWN0aW9uKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMubG9nKCdTZXQgcmVtb3RlIHNlc3Npb24gZGVzY3JpcHRpb24gc3VjY2Vzcy4nKTtcbiAgICAvLyBCeSBub3cgYWxsIG9uYWRkc3RyZWFtIGV2ZW50cyBmb3IgdGhlIHNldFJlbW90ZURlc2NyaXB0aW9uIGhhdmUgZmlyZWQsXG4gICAgLy8gc28gd2UgY2FuIGtub3cgaWYgdGhlIHBlZXIgaGFzIGFueSByZW1vdGUgdmlkZW8gc3RyZWFtcyB0aGF0IHdlIG5lZWRcbiAgICAvLyB0byB3YWl0IGZvci4gT3RoZXJ3aXNlLCB0cmFuc2l0aW9uIGltbWVkaWF0ZWx5IHRvIHRoZSBhY3RpdmUgc3RhdGUuXG4gICAgY29uc3QgcmVtb3RlU3RyZWFtcyA9IHRoaXMuY29ubmVjdGlvbi5nZXRSZWNlaXZlcnMoKTtcbiAgICBpZiAocmVtb3RlU3RyZWFtcy5sZW5ndGgpIHtcbiAgICAgIGZvciAoY29uc3Qgc3RyZWFtIG9mIHJlbW90ZVN0cmVhbXMpIHtcbiAgICAgICAgdGhpcy5yZW1vdGVzRGVzY3JpcHRpb25TZXQubmV4dChzdHJlYW0udHJhY2spO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgbG9nKC4uLmFyZ3M6IGFueVtdKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuc2V0dGluZ3MuZGVidWcpIHtcbiAgICAgIGNvbnNvbGUubG9nKHRoaXMuaWQsIC4uLmFyZ3MpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZXJyb3IoLi4uYXJnczogYW55W10pOiB2b2lkIHtcbiAgICBpZiAodGhpcy5zZXR0aW5ncy5kZWJ1Zykge1xuICAgICAgY29uc29sZS5lcnJvcih0aGlzLmlkLCAuLi5hcmdzKTtcbiAgICB9XG4gIH1cblxufVxuIl19