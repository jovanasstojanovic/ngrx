import { Inject, Injectable } from '@angular/core';
import { BehaviorSubject } from 'rxjs';
import { Configuration } from '../ngx-webrtc-configuration';
import { NGX_WEBRTC_STORAGE } from '../ngx-webrtc-storage';
import { NGX_WEBRTC_STORAGE_PREFIX } from '../ngx-webrtc-storage-prefix';
import * as i0 from "@angular/core";
import * as i1 from "../ngx-webrtc-configuration";
export class PreferencesService {
    constructor(config, prefix, storage) {
        this.config = config;
        this.prefix = prefix;
        this.storage = storage;
        this.preferredAudioInputDevice$ = new BehaviorSubject(null);
        this.preferredAudioOutputDevice$ = new BehaviorSubject(null);
        this.preferredVideoInputDevice$ = new BehaviorSubject(null);
        this.preferredAudioInputDeviceVolume$ = new BehaviorSubject(null);
        this.VIDEO_INPUT_KEY = this.storageKey('preferred-video-input-device');
        this.AUDIO_INPUT_KEY = this.storageKey('preferred-audio-input-device');
        this.AUDIO_INPUT_VOLUME_KEY = this.storageKey('preferred-audio-input-device');
        this.AUDIO_OUTPUT_KEY = this.storageKey('preferred-audio-input-device');
        this.subs = [];
        this.initPreferredDevicesFromStorag();
    }
    ngOnDestroy() {
        this.subs.forEach(sub => {
            sub.unsubscribe();
        });
    }
    storageKey(key) {
        return [this.prefix, key].join('-');
    }
    initSubscription(subject, key) {
        this.subs.push(subject.subscribe(newValue => {
            if (typeof newValue === 'string' || typeof newValue === 'number') {
                window[this.storage].setItem(key, `${newValue}`);
            }
            else {
                window[this.storage].removeItem(key);
            }
        }));
    }
    setInitalValuesFromStorage() {
        this.preferredVideoInputDevice$.next(window[this.storage].getItem(this.VIDEO_INPUT_KEY));
        this.preferredAudioInputDevice$.next(window[this.storage].getItem(this.AUDIO_INPUT_KEY));
        const inputDeviceVolumeStorage = window[this.storage].getItem(this.AUDIO_INPUT_VOLUME_KEY);
        if (inputDeviceVolumeStorage) {
            const inputDeviceVolume = parseInt(inputDeviceVolumeStorage, 10);
            this.preferredAudioInputDeviceVolume$.next(inputDeviceVolume);
        }
        this.preferredAudioOutputDevice$.next(window[this.storage].getItem(this.AUDIO_OUTPUT_KEY));
    }
    initPreferredDevicesFromStorag() {
        if (this.config.savePreferredDeviceInStorage) {
            this.setInitalValuesFromStorage();
            this.initSubscription(this.preferredVideoInputDevice$, this.VIDEO_INPUT_KEY);
            this.initSubscription(this.preferredAudioInputDevice$, this.AUDIO_INPUT_KEY);
            this.initSubscription(this.preferredAudioOutputDevice$, this.AUDIO_OUTPUT_KEY);
            this.initSubscription(this.preferredAudioInputDeviceVolume$, this.AUDIO_INPUT_VOLUME_KEY);
        }
    }
    getAudioConstraintWithPreferences() {
        const preferredAudioInputDevice = this.preferredAudioInputDevice$.getValue();
        const preferredAudioInputDeviceVolume = this.preferredAudioInputDeviceVolume$.getValue();
        let audioConstraint = true;
        if (preferredAudioInputDevice || preferredAudioInputDeviceVolume !== null) {
            if (preferredAudioInputDevice && preferredAudioInputDeviceVolume !== null) {
                audioConstraint = {
                    deviceId: preferredAudioInputDevice,
                    volume: preferredAudioInputDeviceVolume
                };
            }
            else if (preferredAudioInputDevice) {
                audioConstraint = {
                    deviceId: preferredAudioInputDevice
                };
            }
            else if (preferredAudioInputDeviceVolume) {
                audioConstraint = {
                    volume: preferredAudioInputDeviceVolume
                };
            }
        }
        return audioConstraint;
    }
    getVideoConstraintWithPreferences() {
        const preferredVideoInputDevice = this.preferredVideoInputDevice$.getValue();
        return preferredVideoInputDevice ? { deviceId: preferredVideoInputDevice } : true;
    }
    setPreferredAudioInputDevice(deviceId) {
        this.preferredAudioInputDevice$.next(deviceId);
    }
    setPreferredAudioOutputDevice(deviceId) {
        this.preferredAudioOutputDevice$.next(deviceId);
    }
    setPreferredVideoInputDevice(deviceId) {
        this.preferredVideoInputDevice$.next(deviceId);
    }
    setPreferredAudioInputDeviceVolume(volume) {
        this.preferredAudioInputDeviceVolume$.next(volume);
    }
    resetPreferences() {
        this.preferredAudioInputDevice$.next(null);
        this.preferredAudioOutputDevice$.next(null);
        this.preferredVideoInputDevice$.next(null);
        this.preferredAudioInputDeviceVolume$.next(null);
    }
}
PreferencesService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.2.1", ngImport: i0, type: PreferencesService, deps: [{ token: i1.Configuration }, { token: NGX_WEBRTC_STORAGE_PREFIX }, { token: NGX_WEBRTC_STORAGE }], target: i0.ɵɵFactoryTarget.Injectable });
PreferencesService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "13.2.1", ngImport: i0, type: PreferencesService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.2.1", ngImport: i0, type: PreferencesService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root'
                }]
        }], ctorParameters: function () { return [{ type: i1.Configuration }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [NGX_WEBRTC_STORAGE_PREFIX]
                }] }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [NGX_WEBRTC_STORAGE]
                }] }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJlZmVyZW5jZXMuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL2xpYnMvbmd4LXdlYnJ0Yy9zcmMvbGliL3NlcnZpY2VzL3ByZWZlcmVuY2VzLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQWEsTUFBTSxlQUFlLENBQUM7QUFDOUQsT0FBTyxFQUFFLGVBQWUsRUFBZ0IsTUFBTSxNQUFNLENBQUM7QUFDckQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBQzVELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQzNELE9BQU8sRUFBRSx5QkFBeUIsRUFBRSxNQUFNLDhCQUE4QixDQUFDOzs7QUFLekUsTUFBTSxPQUFPLGtCQUFrQjtJQWE3QixZQUNtQixNQUFxQixFQUNjLE1BQWMsRUFDckIsT0FBMEM7UUFGdEUsV0FBTSxHQUFOLE1BQU0sQ0FBZTtRQUNjLFdBQU0sR0FBTixNQUFNLENBQVE7UUFDckIsWUFBTyxHQUFQLE9BQU8sQ0FBbUM7UUFkbEYsK0JBQTBCLEdBQUcsSUFBSSxlQUFlLENBQWdCLElBQUksQ0FBQyxDQUFDO1FBQ3RFLGdDQUEyQixHQUFHLElBQUksZUFBZSxDQUFnQixJQUFJLENBQUMsQ0FBQztRQUN2RSwrQkFBMEIsR0FBRyxJQUFJLGVBQWUsQ0FBZ0IsSUFBSSxDQUFDLENBQUM7UUFDdEUscUNBQWdDLEdBQUcsSUFBSSxlQUFlLENBQWdCLElBQUksQ0FBQyxDQUFDO1FBQ2xFLG9CQUFlLEdBQVcsSUFBSSxDQUFDLFVBQVUsQ0FBQyw4QkFBOEIsQ0FBQyxDQUFDO1FBQzFFLG9CQUFlLEdBQVcsSUFBSSxDQUFDLFVBQVUsQ0FBQyw4QkFBOEIsQ0FBQyxDQUFDO1FBQzFFLDJCQUFzQixHQUFXLElBQUksQ0FBQyxVQUFVLENBQUMsOEJBQThCLENBQUMsQ0FBQztR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Q0Qsa0NBQWtDLENBQUMsTUFBYztRQUMvQyxJQUFJLENBQUMsZ0NBQWdDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ3JELENBQUM7SUFFRCxnQkFBZ0I7UUFDZCxJQUFJLENBQUMsMEJBQTBCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzNDLElBQUksQ0FBQywyQkFBMkIsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDNUMsSUFBSSxDQUFDLDBCQUEwQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUMzQyxJQUFJLENBQUMsZ0NBQWdDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ25ELENBQUM7OytHQTVHVSxrQkFBa0IsK0NBZW5CLHlCQUF5QixhQUN6QixrQkFBa0I7bUhBaEJqQixrQkFBa0IsY0FGakIsTUFBTTsyRkFFUCxrQkFBa0I7a0JBSDlCLFVBQVU7bUJBQUM7b0JBQ1YsVUFBVSxFQUFFLE1BQU07aUJBQ25COzswQkFnQkksTUFBTTsyQkFBQyx5QkFBeUI7OzBCQUNoQyxNQUFNOzJCQUFDLGtCQUFrQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdCwgSW5qZWN0YWJsZSwgT25EZXN0cm95IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QsIFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgQ29uZmlndXJhdGlvbiB9IGZyb20gJy4uL25neC13ZWJydGMtY29uZmlndXJhdGlvbic7XG5pbXBvcnQgeyBOR1hfV0VCUlRDX1NUT1JBR0UgfSBmcm9tICcuLi9uZ3gtd2VicnRjLXN0b3JhZ2UnO1xuaW1wb3J0IHsgTkdYX1dFQlJUQ19TVE9SQUdFX1BSRUZJWCB9IGZyb20gJy4uL25neC13ZWJydGMtc3RvcmFnZS1wcmVmaXgnO1xuXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBQcmVmZXJlbmNlc1NlcnZpY2UgaW1wbGVtZW50cyBPbkRlc3Ryb3kge1xuXG4gIHB1YmxpYyBwcmVmZXJyZWRBdWRpb0lucHV0RGV2aWNlJCA9IG5ldyBCZWhhdmlvclN1YmplY3Q8c3RyaW5nIHwgbnVsbD4obnVsbCk7XG4gIHB1YmxpYyBwcmVmZXJyZWRBdWRpb091dHB1dERldmljZSQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PHN0cmluZyB8IG51bGw+KG51bGwpO1xuICBwdWJsaWMgcHJlZmVycmVkVmlkZW9JbnB1dERldmljZSQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PHN0cmluZyB8IG51bGw+KG51bGwpO1xuICBwdWJsaWMgcHJlZmVycmVkQXVkaW9JbnB1dERldmljZVZvbHVtZSQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PG51bWJlciB8IG51bGw+KG51bGwpO1xuICBwcml2YXRlIHJlYWRvbmx5IFZJREVPX0lOUFVUX0tFWTogc3RyaW5nID0gdGhpcy5zdG9yYWdlS2V5KCdwcmVmZXJyZWQtdmlkZW8taW5wdXQtZGV2aWNlJyk7XG4gIHByaXZhdGUgcmVhZG9ubHkgQVVESU9fSU5QVVRfS0VZOiBzdHJpbmcgPSB0aGlzLnN0b3JhZ2VLZXkoJ3ByZWZlcnJlZC1hdWRpby1pbnB1dC1kZXZpY2UnKTtcbiAgcHJpdmF0ZSByZWFkb25seSBBVURJT19JTlBVVF9WT0xVTUVfS0VZOiBzdHJpbmcgPSB0aGlzLnN0b3JhZ2VLZXkoJ3ByZWZlcnJlZC1hdWRpby1pbnB1dC1kZXZpY2UnKTtcbiAgcHJpdmF0ZSByZWFkb25seSBBVURJT19PVVRQVVRfS0VZOiBzdHJpbmcgPSB0aGlzLnN0b3JhZ2VLZXkoJ3ByZWZlcnJlZC1hdWRpby1pbnB1dC1kZXZpY2UnKTtcblxuICBwcml2YXRlIHN1YnM6IFN1YnNjcmlwdGlvbltdID0gW107XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBjb25maWc6IENvbmZpZ3VyYXRpb24sXG4gICAgQEluamVjdChOR1hfV0VCUlRDX1NUT1JBR0VfUFJFRklYKSBwcml2YXRlIHJlYWRvbmx5IHByZWZpeDogc3RyaW5nLFxuICAgIEBJbmplY3QoTkdYX1dFQlJUQ19TVE9SQUdFKSBwcml2YXRlIHJlYWRvbmx5IHN0b3JhZ2U6ICdsb2NhbFN0b3JhZ2UnIHwgJ3Nlc3Npb25TdG9yYWdlJyxcbiAgKSB7XG4gICAgdGhpcy5pbml0UHJlZmVycmVkRGV2aWNlc0Zyb21TdG9yYWcoKTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgIHRoaXMuc3Vicy5mb3JFYWNoKHN1YiA9PiB7XG4gICAgICBzdWIudW5zdWJzY3JpYmUoKTtcbiAgICB9KVxuICB9XG5cbiAgcHJpdmF0ZSBzdG9yYWdlS2V5KGtleTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICByZXR1cm4gW3RoaXMucHJlZml4LCBrZXldLmpvaW4oJy0nKTtcbiAgfVxuXG4gIHByaXZhdGUgaW5pdFN1YnNjcmlwdGlvbjxUPihzdWJqZWN0OiBCZWhhdmlvclN1YmplY3Q8VCB8IG51bGw+LCBrZXk6IHN0cmluZyk6IHZvaWQge1xuICAgIHRoaXMuc3Vicy5wdXNoKHN1YmplY3Quc3Vic2NyaWJlKG5ld1ZhbHVlID0+IHtcbiAgICAgIGlmICh0eXBlb2YgbmV3VmFsdWUgPT09ICdzdHJpbmcnIHx8IHR5cGVvZiBuZXdWYWx1ZSA9PT0gJ251bWJlcicpIHtcbiAgICAgICAgd2luZG93W3RoaXMuc3RvcmFnZV0uc2V0SXRlbShrZXksIGAke25ld1ZhbHVlfWApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgd2luZG93W3RoaXMuc3RvcmFnZV0ucmVtb3ZlSXRlbShrZXkpO1xuICAgICAgfVxuICAgIH0pKVxuICB9XG5cbiAgcHJpdmF0ZSBzZXRJbml0YWxWYWx1ZXNGcm9tU3RvcmFnZSgpIHtcbiAgICB0aGlzLnByZWZlcnJlZFZpZGVvSW5wdXREZXZpY2UkLm5leHQod2luZG93W3RoaXMuc3RvcmFnZV0uZ2V0SXRlbSh0aGlzLlZJREVPX0lOUFVUX0tFWSkpO1xuICAgIHRoaXMucHJlZmVycmVkQXVkaW9JbnB1dERldmljZSQubmV4dCh3aW5kb3dbdGhpcy5zdG9yYWdlXS5nZXRJdGVtKHRoaXMuQVVESU9fSU5QVVRfS0VZKSk7XG4gICAgY29uc3QgaW5wdXREZXZpY2VWb2x1bWVTdG9yYWdlID0gd2luZG93W3RoaXMuc3RvcmFnZV0uZ2V0SXRlbSh0aGlzLkFVRElPX0lOUFVUX1ZPTFVNRV9LRVkpO1xuICAgIGlmIChpbnB1dERldmljZVZvbHVtZVN0b3JhZ2UpIHtcbiAgICAgIGNvbnN0IGlucHV0RGV2aWNlVm9sdW1lID0gcGFyc2VJbnQoaW5wdXREZXZpY2VWb2x1bWVTdG9yYWdlLCAxMCk7XG4gICAgICB0aGlzLnByZWZlcnJlZEF1ZGlvSW5wdXREZXZpY2VWb2x1bWUkLm5leHQoaW5wdXREZXZpY2VWb2x1bWUpO1xuICAgIH1cbiAgICB0aGlzLnByZWZlcnJlZEF1ZGlvT3V0cHV0RGV2aWNlJC5uZXh0KHdpbmRvd1t0aGlzLnN0b3JhZ2VdLmdldEl0ZW0odGhpcy5BVURJT19PVVRQVVRfS0VZKSk7XG4gIH1cblxuICBwcml2YXRlIGluaXRQcmVmZXJyZWREZXZpY2VzRnJvbVN0b3JhZygpOiB2b2lkIHtcbiAgICBpZih0aGlzLmNvbmZpZy5zYXZlUHJlZmVycmVkRGV2aWNlSW5TdG9yYWdlKSB7XG4gICAgICB0aGlzLnNldEluaXRhbFZhbHVlc0Zyb21TdG9yYWdlKCk7XG4gICAgICB0aGlzLmluaXRTdWJzY3JpcHRpb248c3RyaW5nPih0aGlzLnByZWZlcnJlZFZpZGVvSW5wdXREZXZpY2UkLCB0aGlzLlZJREVPX0lOUFVUX0tFWSk7XG4gICAgICB0aGlzLmluaXRTdWJzY3JpcHRpb248c3RyaW5nPih0aGlzLnByZWZlcnJlZEF1ZGlvSW5wdXREZXZpY2UkLCB0aGlzLkFVRElPX0lOUFVUX0tFWSk7XG4gICAgICB0aGlzLmluaXRTdWJzY3JpcHRpb248c3RyaW5nPih0aGlzLnByZWZlcnJlZEF1ZGlvT3V0cHV0RGV2aWNlJCwgdGhpcy5BVURJT19PVVRQVVRfS0VZKTtcbiAgICAgIHRoaXMuaW5pdFN1YnNjcmlwdGlvbjxudW1iZXI+KHRoaXMucHJlZmVycmVkQXVkaW9JbnB1dERldmljZVZvbHVtZSQsIHRoaXMuQVVESU9fSU5QVVRfVk9MVU1FX0tFWSk7XG4gICAgfVxuICB9XG5cbiAgZ2V0QXVkaW9Db25zdHJhaW50V2l0aFByZWZlcmVuY2VzKCk6IGJvb2xlYW4gfCB7IGRldmljZUlkPzogc3RyaW5nLCB2b2x1bWU/OiBudW1iZXIgfSB7XG4gICAgY29uc3QgcHJlZmVycmVkQXVkaW9JbnB1dERldmljZSA9IHRoaXMucHJlZmVycmVkQXVkaW9JbnB1dERldmljZSQuZ2V0VmFsdWUoKTtcbiAgICBjb25zdCBwcmVmZXJyZWRBdWRpb0lucHV0RGV2aWNlVm9sdW1lID0gdGhpcy5wcmVmZXJyZWRBdWRpb0lucHV0RGV2aWNlVm9sdW1lJC5nZXRWYWx1ZSgpO1xuICAgIGxldCBhdWRpb0NvbnN0cmFpbnQ6IGJvb2xlYW4gfCB7IGRldmljZUlkPzogc3RyaW5nLCB2b2x1bWU/OiBudW1iZXIgfSAgPSB0cnVlO1xuICAgIGlmIChwcmVmZXJyZWRBdWRpb0lucHV0RGV2aWNlIHx8IHByZWZlcnJlZEF1ZGlvSW5wdXREZXZpY2VWb2x1bWUgIT09IG51bGwpIHtcbiAgICAgIGlmIChwcmVmZXJyZWRBdWRpb0lucHV0RGV2aWNlICYmIHByZWZlcnJlZEF1ZGlvSW5wdXREZXZpY2VWb2x1bWUgIT09IG51bGwpIHtcbiAgICAgICAgYXVkaW9Db25zdHJhaW50ID0ge1xuICAgICAgICAgIGRldmljZUlkOiBwcmVmZXJyZWRBdWRpb0lucHV0RGV2aWNlLFxuICAgICAgICAgIHZvbHVtZTogcHJlZmVycmVkQXVkaW9JbnB1dERldmljZVZvbHVtZVxuICAgICAgICB9XG4gICAgICB9IGVsc2UgaWYgKHByZWZlcnJlZEF1ZGlvSW5wdXREZXZpY2UpIHtcbiAgICAgICAgYXVkaW9Db25zdHJhaW50ID0ge1xuICAgICAgICAgIGRldmljZUlkOiBwcmVmZXJyZWRBdWRpb0lucHV0RGV2aWNlXG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSBpZiAocHJlZmVycmVkQXVkaW9JbnB1dERldmljZVZvbHVtZSkge1xuICAgICAgICBhdWRpb0NvbnN0cmFpbnQgPSB7XG4gICAgICAgICAgdm9sdW1lOiBwcmVmZXJyZWRBdWRpb0lucHV0RGV2aWNlVm9sdW1lXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGF1ZGlvQ29uc3RyYWludDtcbiAgfVxuXG4gIGdldFZpZGVvQ29uc3RyYWludFdpdGhQcmVmZXJlbmNlcygpOiBib29sZWFuIHwgeyBkZXZpY2VJZD86IHN0cmluZyB9ICB7XG4gICAgY29uc3QgcHJlZmVycmVkVmlkZW9JbnB1dERldmljZSA9IHRoaXMucHJlZmVycmVkVmlkZW9JbnB1dERldmljZSQuZ2V0VmFsdWUoKTtcbiAgICByZXR1cm4gcHJlZmVycmVkVmlkZW9JbnB1dERldmljZSA/IHsgZGV2aWNlSWQ6IHByZWZlcnJlZFZpZGVvSW5wdXREZXZpY2UgfSA6IHRydWVcbiAgfVxuXG4gIHNldFByZWZlcnJlZEF1ZGlvSW5wdXREZXZpY2UoZGV2aWNlSWQ6IHN0cmluZyk6IHZvaWQge1xuICAgIHRoaXMucHJlZmVycmVkQXVkaW9JbnB1dERldmljZSQubmV4dChkZXZpY2VJZCk7XG4gIH1cbiAgc2V0UHJlZmVycmVkQXVkaW9PdXRwdXREZXZpY2UoZGV2aWNlSWQ6IHN0cmluZyk6IHZvaWQge1xuICAgIHRoaXMucHJlZmVycmVkQXVkaW9PdXRwdXREZXZpY2UkLm5leHQoZGV2aWNlSWQpO1xuICB9XG4gIHNldFByZWZlcnJlZFZpZGVvSW5wdXREZXZpY2UoZGV2aWNlSWQ6IHN0cmluZyk6IHZvaWQge1xuICAgIHRoaXMucHJlZmVycmVkVmlkZW9JbnB1dERldmljZSQubmV4dChkZXZpY2VJZCk7XG4gIH1cbiAgc2V0UHJlZmVycmVkQXVkaW9JbnB1dERldmljZVZvbHVtZSh2b2x1bWU6IG51bWJlcik6IHZvaWQge1xuICAgIHRoaXMucHJlZmVycmVkQXVkaW9JbnB1dERldmljZVZvbHVtZSQubmV4dCh2b2x1bWUpO1xuICB9XG5cbiAgcmVzZXRQcmVmZXJlbmNlcygpOiB2b2lkIHtcbiAgICB0aGlzLnByZWZlcnJlZEF1ZGlvSW5wdXREZXZpY2UkLm5leHQobnVsbCk7XG4gICAgdGhpcy5wcmVmZXJyZWRBdWRpb091dHB1dERldmljZSQubmV4dChudWxsKTtcbiAgICB0aGlzLnByZWZlcnJlZFZpZGVvSW5wdXREZXZpY2UkLm5leHQobnVsbCk7XG4gICAgdGhpcy5wcmVmZXJyZWRBdWRpb0lucHV0RGV2aWNlVm9sdW1lJC5uZXh0KG51bGwpO1xuICB9XG4gIFxufSJdfQ==