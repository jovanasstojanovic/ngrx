import { EventEmitter, Injectable } from '@angular/core';
import { BehaviorSubject } from 'rxjs';
import { StreamType } from "../enums/stream-type";
import { Configuration } from '../ngx-webrtc-configuration';
import { PreferencesService } from './preferences.service';
import * as i0 from "@angular/core";
import * as i1 from "../ngx-webrtc-configuration";
import * as i2 from "./preferences.service";
export class StreamService {
    constructor(config, preferencesService) {
        this.config = config;
        this.preferencesService = preferencesService;
        /**
         * You can subscribe to localSteam changes
         */
        this.localStream$ = new BehaviorSubject(null);
        /**
         * You can subscribe to screen share changes
         */
        this.localShareScreenStream$ = new BehaviorSubject(null);
        /**
         * Emitted with new Track when `StreamService.replaceTrack` is called
         */
        this.replaceTrack$ = new BehaviorSubject(null);
        /**
         * Emitted when `StreamService.setAudioOutput` is called with new device (Call it when the switch the audio device).
         */
        this.audioOutput$ = new BehaviorSubject(null);
        /**
         * Emitted when the status of the local stream changed e.g. audio or video disabled or enabled.
         */
        this.localStreamStatusChanged = new EventEmitter();
        /**
         * Emitted when the status of the local audio stream changed e.g. audio disabled or enabled.
         */
        this.localAudioStreamStatusChanged = new EventEmitter();
        /**
         * Emitted when the status of the local video stream changed e.g. video disabled or enabled.
         */
        this.localVideoStreamStatusChanged = new EventEmitter();
        /**
         * Set to `true` when the StreamService.tryGetUserMedia is succefull for video (camera).
         * @deprecated
         */
        this.hasVideo = false;
        /**
         * Set to `true` when the StreamService.tryGetUserMedia is succefull for audio (microphone).
         * @deprecated
         */
        this.hasAudio = false;
    }
    /**
     * Get aspect ratio for given width and height.
     * @param width width in pixel
     * @param height height in pixel
     * @returns aspect ratio for the given width and height
     */
    static getAspectRatio(width, height) {
        function gcd(a, b) {
            return b ? gcd(b, a % b) : a;
        }
        const divisor = gcd(width, height);
        return `${width / divisor}x${height / divisor}`;
    }
    /**
     *
     * @param node `HTMLVideoElement` or `HTMLAudioElement` that should play the stream.
     * @param stream stream to set in node
     * @param muted mute audio
     * @param local if set to `true` `localStreamStatusChanged` is emitted on play
     */
    setStreamInNode(node, stream, muted = true, local = false) {
        // eslint-disable-next-line @typescript-eslint/no-this-alias
        const self = this;
        if (node) {
            // play when ready
            node.addEventListener('canplay', function onCanPlay(event) {
                // it doesn't matter if we use audio or video element here
                const eventTargetNode = event.target;
                if (eventTargetNode) {
                    eventTargetNode.removeEventListener('canplay', onCanPlay);
                    eventTargetNode.play();
                }
                if (local) {
                    self.localStreamStatusChanged.emit(stream);
                }
            });
            let tmpStream;
            if (stream instanceof MediaStreamTrack) {
                tmpStream = new MediaStream();
                tmpStream.addTrack(stream);
            }
            else {
                tmpStream = stream;
            }
            node.srcObject = tmpStream;
            node.muted = muted;
        }
    }
    /**
     * stop stream playing in node
     * @param node node with nativeElement type `HTMLVideoElement` or  `HTMLAudioElement`
     */
    stopStreamInNode(node) {
        node?.nativeElement?.pause();
        node?.nativeElement?.srcObject?.getTracks().forEach((t) => t.stop());
        if (node?.nativeElement?.srcObject) {
            node.nativeElement.srcObject = new MediaStream();
        }
    }
    toggleLocalTrack(type) {
        if (this.config.debug) {
            console.log('toggleLocalTrack()', type);
        }
        const stream = this.getLocalStream();
        if (stream) {
            const tracks = type === StreamType.Audio ? stream.getAudioTracks() : stream.getVideoTracks();
            if (tracks.length) {
                return this.disableLocalTrack(type);
            }
            else {
                return this.enableLocalTrack(type);
            }
        }
        else {
            return Promise.reject(new Error('no stream'));
        }
    }
    enableLocalTrack(type) {
        if (this.config.debug) {
            console.log('enableLocalTrack()', type);
        }
        return new Promise((resolve, rejects) => {
            const stream = this.getLocalStream();
            if (stream) {
                if (type === StreamType.Video) {
                    navigator.mediaDevices.getUserMedia({
                        video: this.preferencesService.getVideoConstraintWithPreferences(),
                    }).then(stream => {
                        const localStream = this.localStream$.getValue() || new MediaStream();
                        stream.getVideoTracks().forEach(track => {
                            localStream.addTrack(track);
                            this.localVideoStreamStatusChanged.emit(true);
                            this.replaceTrack(track);
                        });
                        this.localStream$.next(localStream);
                        this.localStreamStatusChanged.emit(localStream);
                        resolve(localStream);
                    }, (error) => {
                        rejects(error);
                    });
                }
                if (type === StreamType.Audio) {
                    navigator.mediaDevices.getUserMedia({
                        audio: this.preferencesService.getAudioConstraintWithPreferences(),
                    }).then(stream => {
                        const localStream = this.localStream$.getValue() || new MediaStream();
                        stream.getAudioTracks().forEach(track => {
                            localStream.addTrack(track);
                            this.localAudioStreamStatusChanged.emit(true);
                            this.replaceTrack(track);
                        });
                        this.localStream$.next(localStream);
                        this.localStreamStatusChanged.emit(localStream);
                        resolve(localStream);
                    }, (error) => {
                        rejects(error);
                    });
                }
            }
            else {
                rejects(new Error('no stream'));
            }
        });
    }
    disableLocalTrack(type) {
        if (this.config.debug) {
            console.log('disableLocalTrack()', type);
        }
        return new Promise((resolve, rejects) => {
            const stream = this.getLocalStream();
            if (stream) {
                const tracks = type === StreamType.Audio ? stream.getAudioTracks() : stream.getVideoTracks();
                tracks.forEach(track => {
                    track.enabled = false;
                    track.stop();
                    stream.removeTrack(track);
                });
                if (type === StreamType.Video) {
                    this.localVideoStreamStatusChanged.emit(false);
                }
                else {
                    this.localAudioStreamStatusChanged.emit(false);
                }
                this.localStreamStatusChanged.emit(stream);
                this.localStream$.next(stream);
                return resolve(stream);
            }
            else {
                rejects(new Error('no stream'));
            }
        });
    }
    /**
     * set stream or track mute state or toggle mute
     * @param stream stream or track
     * @param type stream or track type
     * @param value enforce `true` or `false`
     */
    toggleMuteStream(stream, type, value) {
        if (this.config.debug) {
            console.log('toggleMuteStream()', stream, type, value);
        }
        if (stream) {
            if (stream instanceof MediaStreamTrack) {
                const targetValue = typeof value !== 'undefined' ? value : !stream.enabled;
                stream.enabled = targetValue;
            }
            else {
                if (type === StreamType.Audio) {
                    stream.getAudioTracks().forEach(track => {
                        const targetValue = typeof value !== 'undefined' ? value : !track.enabled;
                        track.enabled = targetValue;
                        this.localAudioStreamStatusChanged.emit(targetValue);
                    });
                }
                if (type === StreamType.Video) {
                    stream.getVideoTracks().forEach(track => {
                        const targetValue = typeof value !== 'undefined' ? value : !track.enabled;
                        track.enabled = targetValue;
                        this.localVideoStreamStatusChanged.emit(targetValue);
                    });
                }
            }
        }
        this.localStreamStatusChanged.emit(stream);
    }
    /**
     * Mute stream in node.
     * @param stream stram or track
     * @param type stream or track type
     */
    muteStream(stream, type) {
        this.toggleMuteStream(stream, type, false);
    }
    /**
     * Unmute stream in node.
     * @param stream stram or track
     * @param type stream or track type
     */
    unmuteStream(stream, type) {
        this.toggleMuteStream(stream, type, true);
    }
    /**
     * replace a track in stream
     * @param stream stream with thre track to replace
     * @param track new track
     */
    replaceTrackInStream(stream, track) {
        if (track.kind === StreamType.Video) {
            stream?.getVideoTracks().forEach(e => {
                e.stop();
                stream.removeTrack(e);
            });
        }
        if (track.kind === StreamType.Audio) {
            stream?.getAudioTracks().forEach((e) => {
                e.stop();
                stream.removeTrack(e);
            });
        }
        stream?.addTrack(track);
    }
    /**
     * set local stream in service state
     * @param stream stream to set
     */
    setLocalStream(stream) {
        this.localStream$.next(stream);
    }
    /**
     * get current state value of local stream
     * @returns current local stream
     */
    getLocalStream() {
        return this.localStream$.getValue();
    }
    /**
     * set replace track service state. You can subscribe to `StreamService.replaceTrack$` to update the track somewhere.
     * @param track new track
     */
    replaceTrack(track) {
        this.replaceTrack$.next(track);
    }
    /**
     * toggle mute audio of local stream
     */
    toggleMuteLocalAudioStream() {
        const stream = this.localStream$.getValue();
        if (stream) {
            this.toggleMuteStream(stream, StreamType.Audio);
        }
    }
    /**
     * mute local audio stream
     */
    muteLocalAudioStream() {
        const stream = this.localStream$.getValue();
        if (stream) {
            this.toggleMuteStream(stream, StreamType.Audio, false);
        }
    }
    /**
     * unmute local audio stream
     */
    unmuteLocalAudioStream() {
        const stream = this.localStream$.getValue();
        if (stream) {
            this.toggleMuteStream(stream, StreamType.Audio, true);
        }
    }
    /**
     * toggle mute local video stream
     */
    toggleMuteLocalVideoStream() {
        const stream = this.localStream$.getValue();
        if (stream) {
            this.toggleMuteStream(stream, StreamType.Video);
        }
    }
    /**
     * mute local video stream
     */
    muteLocalVideoStream() {
        const stream = this.localStream$.getValue();
        if (stream) {
            this.toggleMuteStream(stream, StreamType.Video, false);
        }
    }
    /**
     * unmute local video stream
     */
    unmuteLocalVideoStream() {
        const value = this.localStream$.getValue();
        if (value) {
            this.toggleMuteStream(value, StreamType.Video, true);
        }
    }
    /**
     * get screen or window as stream
     * @returns MediaStram of desktop or display
     */
    async getScreenCapture() {
        let stream = null;
        try {
            // eslint-disable-next-line @typescript-eslint/no-explicit-any
            const n = navigator;
            if (n.getDisplayMedia) {
                stream = await n.getDisplayMedia({ video: true });
            }
            else if (n.mediaDevices.getDisplayMedia) {
                stream = await n.mediaDevices.getDisplayMedia({ video: true });
            }
            else {
                stream = await n.mediaDevices.getUserMedia({ video: { mediaSource: 'screen' } });
            }
        }
        catch (e) {
            if (this.config.debug) {
                console.log(`MdoVideoCallComponent.getScreenCapture() -> no permissions`);
            }
        }
        return stream;
    }
    /**
     * get first/single video track of the given stream
     * @param stream stream with video treack
     * @returns first video track of stream
     */
    getVideoTrackForStream(stream) {
        if (!stream && this.getLocalStream()) {
            stream = this.getLocalStream();
        }
        return stream?.getVideoTracks()[0] || null;
    }
    /**
     * get first/single audio track of the given stream
     * @param stream stream with audio treack
     * @returns first audio track of stream
     */
    getAudioTrackForStream(stream) {
        if (!stream && this.getLocalStream()) {
            stream = this.getLocalStream();
        }
        return stream?.getAudioTracks()[0] || null;
    }
    /**
     * get media devices, Attention you need getMedia permissions for this call
     * @returns Promise that resolves to media Devices as array
     * @deprecated use DeviceService.getMediaDevices() instead
     */
    getMediaDevices() {
        return navigator.mediaDevices.enumerateDevices();
    }
    /**
     * set current audio device in service state. You can subscribe to `StreamService.audioOutput$` to get changes.
     * @param deviceId
     */
    setAudioOutput(deviceId) {
        this.audioOutput$.next(deviceId);
    }
    // TODO: refactor
    /**
     * An simple wrapper for `navigator.mediaDevices.getUserMedia`, with basis error handling.
     * @todo refactor
     * @param mediaConstraints a MediaStreamConstraints e.g. with specific deviceId, resolution or just audio. Default is:
     *                          ```json
     *                         {
     *                             audio: true,
     *                             video: true
     *                         }
     *                         ```
     * @returns Promise that resilve to a stream matching the constraint
     * @deprecated use DeviceService.tryGetUserMedia() instead
     */
    tryGetUserMedia(mediaConstraints) {
        // reset state
        this.hasAudio = false;
        this.hasVideo = false;
        if (!mediaConstraints) {
            mediaConstraints = {
                audio: true,
                video: true
            };
        }
        ;
        return new Promise((resolve, reject) => {
            navigator.mediaDevices.getUserMedia(mediaConstraints).then(a => {
                this.hasAudio = true;
                this.hasVideo = true;
                resolve(a);
            }, b => {
                let cam = true, mic = true;
                if (b.message.indexOf('Starting videoinput failed') > -1) {
                    if (this.config.debug) {
                        console.log('videoinput used by another software');
                    }
                    cam = false;
                }
                navigator.mediaDevices.enumerateDevices().then((devices) => {
                    cam = cam && devices.find((device) => {
                        return device.kind === 'videoinput';
                    }) !== null;
                    mic = devices.find((device) => {
                        return device.kind === 'audioinput';
                    }) !== null;
                    const constraints = {
                        video: cam && mediaConstraints?.video,
                        audio: mic && mediaConstraints?.audio
                    };
                    navigator.mediaDevices.getUserMedia(constraints).then(a => {
                        this.hasAudio = true;
                        resolve(a);
                    }, reject);
                }, (f) => {
                    reject(f);
                });
            }).catch(e => {
                reject(e);
            });
        });
    }
}
StreamService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.2.1", ngImport: i0, type: StreamService, deps: [{ token: i1.Configuration }, { token: i2.PreferencesService }], target: i0.ɵɵFactoryTarget.Injectable });
StreamService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "13.2.1", ngImport: i0, type: StreamService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.2.1", ngImport: i0, type: StreamService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root'
                }]
        }], ctorParameters: function () { return [{ type: i1.Configuration }, { type: i2.PreferencesService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RyZWFtLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9saWJzL25neC13ZWJydGMvc3JjL2xpYi9zZXJ2aWNlcy9zdHJlYW0uc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQWMsWUFBWSxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNyRSxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3ZDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUNsRCxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFDNUQsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7Ozs7QUFLM0QsTUFBTSxPQUFPLGFBQWE7SUFnRHhCLFlBQ21CLE1BQXFCLEVBQzlCLGtCQUFzQztRQUQ3QixXQUFNLEdBQU4sTUFBTSxDQUFlO1FBQzlCLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBb0I7UUFoRGhEOztXQUVHO1FBQ0ksaUJBQVksR0FBRyxJQUFJLGVBQWUsQ0FBcUIsSUFBSSxDQUFDLENBQUM7UUFDcEU7O1dBRUc7UUFDSSw0QkFBdUIsR0FBRyxJQUFJLGVBQWUsQ0FBcUIsSUFBSSxDQUFDLENBQUM7UUFFL0U7O1dBRUc7UUFDSSxrQkFBYSxHQUFHLElBQUksZUFBZSxDQUEwQixJQUFJLENBQUMsQ0FBQztRQUUxRTs7V0FFRztRQUNJLGlCQUFZLEdBQUcsSUFBSSxlQUFlLENBQWdCLElBQUksQ0FBQyxDQUFDO1FBRS9EOztXQUVHO1FBQ0ksNkJBQXdCLEdBQUcsSUFBSSxZQUFZLEVBQWtDLENBQUM7UUFFckY7O1dBRUc7UUFDSSxrQ0FBNkIsR0FBRyxJQUFJLFlBQVksRUFBVyxDQUFDO1FBRW5FOztXQUVHO1FBQ0ksa0NBQTZCLEdBQUcsSUFBSSxZQUFZLEVBQVcsQ0FBQztRQUVuRTs7O1dBR0c7UUFD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QUVQLGFBQWE7a0JBSHpCLFVBQVU7bUJBQUM7b0JBQ1YsVUFBVSxFQUFFLE1BQU07aUJBQ25CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRWxlbWVudFJlZiwgRXZlbnRFbWl0dGVyLCBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IFN0cmVhbVR5cGUgfSBmcm9tIFwiLi4vZW51bXMvc3RyZWFtLXR5cGVcIjtcbmltcG9ydCB7IENvbmZpZ3VyYXRpb24gfSBmcm9tICcuLi9uZ3gtd2VicnRjLWNvbmZpZ3VyYXRpb24nO1xuaW1wb3J0IHsgUHJlZmVyZW5jZXNTZXJ2aWNlIH0gZnJvbSAnLi9wcmVmZXJlbmNlcy5zZXJ2aWNlJztcblxuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgU3RyZWFtU2VydmljZSB7XG5cbiAgLyoqXG4gICAqIFlvdSBjYW4gc3Vic2NyaWJlIHRvIGxvY2FsU3RlYW0gY2hhbmdlc1xuICAgKi9cbiAgcHVibGljIGxvY2FsU3RyZWFtJCA9IG5ldyBCZWhhdmlvclN1YmplY3Q8TWVkaWFTdHJlYW0gfCBudWxsPihudWxsKTtcbiAgLyoqXG4gICAqIFlvdSBjYW4gc3Vic2NyaWJlIHRvIHNjcmVlbiBzaGFyZSBjaGFuZ2VzXG4gICAqL1xuICBwdWJsaWMgbG9jYWxTaGFyZVNjcmVlblN0cmVhbSQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PE1lZGlhU3RyZWFtIHwgbnVsbD4obnVsbCk7XG5cbiAgLyoqXG4gICAqIEVtaXR0ZWQgd2l0aCBuZXcgVHJhY2sgd2hlbiBgU3RyZWFtU2VydmljZS5yZXBsYWNlVHJhY2tgIGlzIGNhbGxlZCBcbiAgICovXG4gIHB1YmxpYyByZXBsYWNlVHJhY2skID0gbmV3IEJlaGF2aW9yU3ViamVjdDxNZWRpYVN0cmVhbVRyYWNrIHwgbnVsbD4obnVsbCk7XG5cbiAgLyoqXG4gICAqIEVtaXR0ZWQgd2hlbiBgU3RyZWFtU2VydmljZS5zZXRBdWRpb091dHB1dGAgaXMgY2FsbGVkIHdpdGggbmV3IGRldmljZSAoQ2FsbCBpdCB3aGVuIHRoZSBzd2l0Y2ggdGhlIGF1ZGlvIGRldmljZSkuXG4gICAqL1xuICBwdWJsaWMgYXVkaW9PdXRwdXQkID0gbmV3IEJlaGF2aW9yU3ViamVjdDxzdHJpbmcgfCBudWxsPihudWxsKTtcblxuICAvKipcbiAgICogRW1pdHRlZCB3aGVuIHRoZSBzdGF0dXMgb2YgdGhlIGxvY2FsIHN0cmVhbSBjaGFuZ2VkIGUuZy4gYXVkaW8gb3IgdmlkZW8gZGlzYWJsZWQgb3IgZW5hYmxlZC5cbiAgICovXG4gIHB1YmxpYyBsb2NhbFN0cmVhbVN0YXR1c0NoYW5nZWQgPSBuZXcgRXZlbnRFbWl0dGVyPE1lZGlhU3RyZWFtIHwgTWVkaWFTdHJlYW1UcmFjaz4oKTtcblxuICAvKipcbiAgICogRW1pdHRlZCB3aGVuIHRoZSBzdGF0dXMgb2YgdGhlIGxvY2FsIGF1ZGlvIHN0cmVhbSBjaGFuZ2VkIGUuZy4gYXVkaW8gZGlzYWJsZWQgb3IgZW5hYmxlZC5cbiAgICovXG4gIHB1YmxpYyBsb2NhbEF1ZGlvU3RyZWFtU3RhdHVzQ2hhbmdlZCA9IG5ldyBFdmVudEVtaXR0ZXI8Ym9vbGVhbj4oKTtcblxuICAvKipcbiAgICogRW1pdHRlZCB3aGVuIHRoZSBzdGF0dXMgb2YgdGhlIGxvY2FsIHZpZGVvIHN0cmVhbSBjaGFuZ2VkIGUuZy4gdmlkZW8gZGlzYWJsZWQgb3IgZW5hYmxlZC5cbiAgICovXG4gIHB1YmxpYyBsb2NhbFZpZGVvU3RyZWFtU3RhdHVzQ2hhbmdlZCA9IG5ldyBFdmVudEVtaXR0ZXI8Ym9vbGVhbj4oKTtcblxuICAvKipcbiAgICogU2V0IHRvIGB0cnVlYCB3aGVuIHRoZSBTdHJlYW1TZXJ2aWNlLnRyeUdldFVzZXJNZWRpYSBpcyBzdWNjZWZ1bGwgZm9yIHZpZGVvIChjYW1lcmEpLlxuICAgKiBAZGVwcmVjYXRlZFxuICAgKi9cbiAgcHVibGljIGhhc1ZpZGVvID0gZmFsc2U7XG5cbiAgLyoqXG4gICAqIFNldCB0byBgdHJ1ZWAgd2hlbiB0aGUgU3RyZWFtU2VydmljZS50cnlHZXRVc2VyTWVkaWEgaXMgc3VjY2VmdWxsIGZvciBhdWRpbyAobWljcm9waG9uZSkuXG4gICAqIEBkZXByZWNhdGVkXG4gICAqL1xuICBwdWJsaWMgaGFzQXVkaW8gPSBmYWxzZTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IGNvbmZpZzogQ29uZmlndXJhdGlvbixcbiAgICBwcml2YXRlIHByZWZlcmVuY2VzU2VydmljZTogUHJlZmVyZW5jZXNTZXJ2aWNlLFxuICApe31cblxuXG4gIC8qKlxuICAgKiBHZXQgYXNwZWN0IHJhdGlvIGZvciBnaXZlbiB3aWR0aCBhbmQgaGVpZ2h0LlxuICAgKiBAcGFyYW0gd2lkdGggd2lkdGggaW4gcGl4ZWxcbiAgICogQHBhcmFtIGhlaWdodCBoZWlnaHQgaW4gcGl4ZWxcbiAgICogQHJldHVybnMgYXNwZWN0IHJhdGlvIGZvciB0aGUgZ2l2ZW4gd2lkdGggYW5kIGhlaWdodFxuICAgKi9cbiAgcHVibGljIHN0YXRpYyBnZXRBc3BlY3RSYXRpbyh3aWR0aDogbnVtYmVyLCBoZWlnaHQ6IG51bWJlcik6IHN0cmluZyB7XG5cbiAgICBmdW5jdGlvbiBnY2QoYTogbnVtYmVyLCBiOiBudW1iZXIpOiBudW1iZXIge1xuICAgICAgcmV0dXJuIGIgPyBnY2QoYiwgYSAlIGIpIDogYTtcbiAgICB9XG5cbiAgICBjb25zdCBkaXZpc29yOiBudW1iZXIgPSBnY2Qod2lkdGgsIGhlaWdodCk7XG4gICAgcmV0dXJuIGAke3dpZHRoIC8gZGl2aXNvcn14JHtoZWlnaHQgLyBkaXZpc29yfWA7XG4gIH1cblxuICAvKipcbiAgICogXG4gICAqIEBwYXJhbSBub2RlIGBIVE1MVmlkZW9FbGVtZW50YCBvciBgSFRNTEF1ZGlvRWxlbWVudGAgdGhhdCBzaG91bGQgcGxheSB0aGUgc3RyZWFtLlxuICAgKiBAcGFyYW0gc3RyZWFtIHN0cmVhbSB0byBzZXQgaW4gbm9kZSBcbiAgICogQHBhcmFtIG11dGVkIG11dGUgYXVkaW9cbiAgICogQHBhcmFtIGxvY2FsIGlmIHNldCB0byBgdHJ1ZWAgYGxvY2FsU3RyZWFtU3RhdHVzQ2hhbmdlZGAgaXMgZW1pdHRlZCBvbiBwbGF5XG4gICAqL1xuICBwdWJsaWMgc2V0U3RyZWFtSW5Ob2RlKG5vZGU6IEhUTUxWaWRlb0VsZW1lbnQgfCBIVE1MQXVkaW9FbGVtZW50LCBzdHJlYW06IE1lZGlhU3RyZWFtIHwgTWVkaWFTdHJlYW1UcmFjaywgbXV0ZWQgPSB0cnVlLCBsb2NhbCA9IGZhbHNlKTogdm9pZCB7XG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby10aGlzLWFsaWFzXG4gICAgY29uc3Qgc2VsZiA9IHRoaXM7XG4gICAgaWYgKG5vZGUpIHtcblxuICAgICAgLy8gcGxheSB3aGVuIHJlYWR5XG4gICAgICBub2RlLmFkZEV2ZW50TGlzdGVuZXIoJ2NhbnBsYXknLCBmdW5jdGlvbiBvbkNhblBsYXkoZXZlbnQpIHtcbiAgICAgICAgLy8gaXQgZG9lc24ndCBtYXR0ZXIgaWYgd2UgdXNlIGF1ZGlvIG9yIHZpZGVvIGVsZW1lbnQgaGVyZVxuICAgICAgICBjb25zdCBldmVudFRhcmdldE5vZGU6IEhUTUxWaWRlb0VsZW1lbnQgPSBldmVudC50YXJnZXQgYXMgSFRNTFZpZGVvRWxlbWVudDtcbiAgICAgICAgaWYgKGV2ZW50VGFyZ2V0Tm9kZSkge1xuICAgICAgICAgIGV2ZW50VGFyZ2V0Tm9kZS5yZW1vdmVFdmVudExpc3RlbmVyKCdjYW5wbGF5Jywgb25DYW5QbGF5KTtcbiAgICAgICAgICBldmVudFRhcmdldE5vZGUucGxheSgpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChsb2NhbCkge1xuICAgICAgICAgIHNlbGYubG9jYWxTdHJlYW1TdGF0dXNDaGFuZ2VkLmVtaXQoc3RyZWFtKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICAgIGxldCB0bXBTdHJlYW07XG4gICAgICBpZiAoc3RyZWFtIGluc3RhbmNlb2YgTWVkaWFTdHJlYW1UcmFjaykge1xuICAgICAgICB0bXBTdHJlYW0gPSBuZXcgTWVkaWFTdHJlYW0oKTtcbiAgICAgICAgdG1wU3RyZWFtLmFkZFRyYWNrKHN0cmVhbSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0bXBTdHJlYW0gPSBzdHJlYW07XG4gICAgICB9XG4gICAgICBub2RlLnNyY09iamVjdCA9IHRtcFN0cmVhbTtcbiAgICAgIG5vZGUubXV0ZWQgPSBtdXRlZDtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogc3RvcCBzdHJlYW0gcGxheWluZyBpbiBub2RlXG4gICAqIEBwYXJhbSBub2RlIG5vZGUgd2l0aCBuYXRpdmVFbGVtZW50IHR5cGUgYEhUTUxWaWRlb0VsZW1lbnRgIG9yICBgSFRNTEF1ZGlvRWxlbWVudGBcbiAgICovXG4gIHB1YmxpYyBzdG9wU3RyZWFtSW5Ob2RlKG5vZGU6IEVsZW1lbnRSZWYpOiB2b2lkIHtcbiAgICBub2RlPy5uYXRpdmVFbGVtZW50Py5wYXVzZSgpO1xuICAgIG5vZGU/Lm5hdGl2ZUVsZW1lbnQ/LnNyY09iamVjdD8uZ2V0VHJhY2tzKCkuZm9yRWFjaCgodDogTWVkaWFTdHJlYW1UcmFjaykgPT4gdC5zdG9wKCkpO1xuICAgIGlmIChub2RlPy5uYXRpdmVFbGVtZW50Py5zcmNPYmplY3QpIHtcbiAgICAgIG5vZGUubmF0aXZlRWxlbWVudC5zcmNPYmplY3QgPSBuZXcgTWVkaWFTdHJlYW0oKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgdG9nZ2xlTG9jYWxUcmFjayh0eXBlOiBTdHJlYW1UeXBlKTogUHJvbWlzZTxNZWRpYVN0cmVhbT4ge1xuICAgIGlmICh0aGlzLmNvbmZpZy5kZWJ1Zykge1xuICAgICAgY29uc29sZS5sb2coJ3RvZ2dsZUxvY2FsVHJhY2soKScsIHR5cGUpO1xuICAgIH1cbiAgICBjb25zdCBzdHJlYW0gPSB0aGlzLmdldExvY2FsU3RyZWFtKCk7XG4gICAgaWYgKHN0cmVhbSkge1xuICAgICAgY29uc3QgdHJhY2tzID0gdHlwZSA9PT0gU3RyZWFtVHlwZS5BdWRpbyA/IHN0cmVhbS5nZXRBdWRpb1RyYWNrcygpIDogc3RyZWFtLmdldFZpZGVvVHJhY2tzKCk7XG4gICAgICBpZiAodHJhY2tzLmxlbmd0aCkge1xuICAgICAgICByZXR1cm4gdGhpcy5kaXNhYmxlTG9jYWxUcmFjayh0eXBlKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiB0aGlzLmVuYWJsZUxvY2FsVHJhY2sodHlwZSk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChuZXcgRXJyb3IoJ25vIHN0cmVhbScpKVxuICAgIH1cblxuICB9XG5cbiAgcHVibGljIGVuYWJsZUxvY2FsVHJhY2sodHlwZTogU3RyZWFtVHlwZSk6IFByb21pc2U8TWVkaWFTdHJlYW0+IHtcbiAgICBpZiAodGhpcy5jb25maWcuZGVidWcpIHtcbiAgICAgIGNvbnNvbGUubG9nKCdlbmFibGVMb2NhbFRyYWNrKCknLCB0eXBlKTtcbiAgICB9XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPE1lZGlhU3RyZWFtPigocmVzb2x2ZSwgcmVqZWN0cykgPT4ge1xuICAgICAgY29uc3Qgc3RyZWFtID0gdGhpcy5nZXRMb2NhbFN0cmVhbSgpO1xuICAgICAgaWYgKHN0cmVhbSkge1xuICAgICAgICBpZiAodHlwZSA9PT0gU3RyZWFtVHlwZS5WaWRlbykge1xuICAgICAgICAgIG5hdmlnYXRvci5tZWRpYURldmljZXMuZ2V0VXNlck1lZGlhKHtcbiAgICAgICAgICAgIHZpZGVvOiB0aGlzLnByZWZlcmVuY2VzU2VydmljZS5nZXRWaWRlb0NvbnN0cmFpbnRXaXRoUHJlZmVyZW5jZXMoKSxcbiAgICAgICAgICB9KS50aGVuKHN0cmVhbSA9PiB7XG4gICAgICAgICAgICBjb25zdCBsb2NhbFN0cmVhbSA9IHRoaXMubG9jYWxTdHJlYW0kLmdldFZhbHVlKCkgfHwgbmV3IE1lZGlhU3RyZWFtKCk7XG4gICAgICAgICAgICBzdHJlYW0uZ2V0VmlkZW9UcmFja3MoKS5mb3JFYWNoKHRyYWNrID0+IHtcbiAgICAgICAgICAgICAgbG9jYWxTdHJlYW0uYWRkVHJhY2sodHJhY2spO1xuICAgICAgICAgICAgICB0aGlzLmxvY2FsVmlkZW9TdHJlYW1TdGF0dXNDaGFuZ2VkLmVtaXQodHJ1ZSk7XG4gICAgICAgICAgICAgIHRoaXMucmVwbGFjZVRyYWNrKHRyYWNrKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgdGhpcy5sb2NhbFN0cmVhbSQubmV4dChsb2NhbFN0cmVhbSk7XG4gICAgICAgICAgICB0aGlzLmxvY2FsU3RyZWFtU3RhdHVzQ2hhbmdlZC5lbWl0KGxvY2FsU3RyZWFtKTtcbiAgICAgICAgICAgIHJlc29sdmUobG9jYWxTdHJlYW0pO1xuICAgICAgICAgIH0sIChlcnJvcikgPT4ge1xuICAgICAgICAgICAgcmVqZWN0cyhlcnJvcik7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHR5cGUgPT09IFN0cmVhbVR5cGUuQXVkaW8pIHtcbiAgICAgICAgICBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLmdldFVzZXJNZWRpYSh7XG4gICAgICAgICAgICBhdWRpbzogdGhpcy5wcmVmZXJlbmNlc1NlcnZpY2UuZ2V0QXVkaW9Db25zdHJhaW50V2l0aFByZWZlcmVuY2VzKCksXG4gICAgICAgICAgfSkudGhlbihzdHJlYW0gPT4ge1xuICAgICAgICAgICAgY29uc3QgbG9jYWxTdHJlYW0gPSB0aGlzLmxvY2FsU3RyZWFtJC5nZXRWYWx1ZSgpIHx8IG5ldyBNZWRpYVN0cmVhbSgpO1xuICAgICAgICAgICAgc3RyZWFtLmdldEF1ZGlvVHJhY2tzKCkuZm9yRWFjaCh0cmFjayA9PiB7XG4gICAgICAgICAgICAgIGxvY2FsU3RyZWFtLmFkZFRyYWNrKHRyYWNrKTtcbiAgICAgICAgICAgICAgdGhpcy5sb2NhbEF1ZGlvU3RyZWFtU3RhdHVzQ2hhbmdlZC5lbWl0KHRydWUpO1xuICAgICAgICAgICAgICB0aGlzLnJlcGxhY2VUcmFjayh0cmFjayk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHRoaXMubG9jYWxTdHJlYW0kLm5leHQobG9jYWxTdHJlYW0pO1xuICAgICAgICAgICAgdGhpcy5sb2NhbFN0cmVhbVN0YXR1c0NoYW5nZWQuZW1pdChsb2NhbFN0cmVhbSk7XG4gICAgICAgICAgICByZXNvbHZlKGxvY2FsU3RyZWFtKTtcbiAgICAgICAgICB9LCAoZXJyb3IpID0+IHtcbiAgICAgICAgICAgIHJlamVjdHMoZXJyb3IpO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZWplY3RzKG5ldyBFcnJvcignbm8gc3RyZWFtJykpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGRpc2FibGVMb2NhbFRyYWNrKHR5cGU6IFN0cmVhbVR5cGUpOiBQcm9taXNlPE1lZGlhU3RyZWFtPiB7XG4gICAgaWYgKHRoaXMuY29uZmlnLmRlYnVnKSB7XG4gICAgICBjb25zb2xlLmxvZygnZGlzYWJsZUxvY2FsVHJhY2soKScsIHR5cGUpO1xuICAgIH1cbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdHMpID0+IHtcbiAgICAgIGNvbnN0IHN0cmVhbSA9IHRoaXMuZ2V0TG9jYWxTdHJlYW0oKTtcbiAgICAgIGlmIChzdHJlYW0pIHtcbiAgICAgICAgY29uc3QgdHJhY2tzID0gdHlwZSA9PT0gU3RyZWFtVHlwZS5BdWRpbyA/IHN0cmVhbS5nZXRBdWRpb1RyYWNrcygpIDogc3RyZWFtLmdldFZpZGVvVHJhY2tzKCk7XG4gICAgICAgIHRyYWNrcy5mb3JFYWNoKHRyYWNrID0+IHtcbiAgICAgICAgICB0cmFjay5lbmFibGVkID0gZmFsc2U7XG4gICAgICAgICAgdHJhY2suc3RvcCgpO1xuICAgICAgICAgIHN0cmVhbS5yZW1vdmVUcmFjayh0cmFjaylcbiAgICAgICAgfSk7XG4gICAgICAgIGlmICh0eXBlID09PSBTdHJlYW1UeXBlLlZpZGVvKSB7XG4gICAgICAgICAgdGhpcy5sb2NhbFZpZGVvU3RyZWFtU3RhdHVzQ2hhbmdlZC5lbWl0KGZhbHNlKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aGlzLmxvY2FsQXVkaW9TdHJlYW1TdGF0dXNDaGFuZ2VkLmVtaXQoZmFsc2UpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMubG9jYWxTdHJlYW1TdGF0dXNDaGFuZ2VkLmVtaXQoc3RyZWFtKTtcbiAgICAgICAgdGhpcy5sb2NhbFN0cmVhbSQubmV4dChzdHJlYW0pO1xuICAgICAgICByZXR1cm4gcmVzb2x2ZShzdHJlYW0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmVqZWN0cyhuZXcgRXJyb3IoJ25vIHN0cmVhbScpKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBzZXQgc3RyZWFtIG9yIHRyYWNrIG11dGUgc3RhdGUgb3IgdG9nZ2xlIG11dGVcbiAgICogQHBhcmFtIHN0cmVhbSBzdHJlYW0gb3IgdHJhY2tcbiAgICogQHBhcmFtIHR5cGUgc3RyZWFtIG9yIHRyYWNrIHR5cGVcbiAgICogQHBhcmFtIHZhbHVlIGVuZm9yY2UgYHRydWVgIG9yIGBmYWxzZWBcbiAgICovXG4gIHB1YmxpYyB0b2dnbGVNdXRlU3RyZWFtKHN0cmVhbTogTWVkaWFTdHJlYW0gfCBNZWRpYVN0cmVhbVRyYWNrLCB0eXBlOiBTdHJlYW1UeXBlLCB2YWx1ZT86IGJvb2xlYW4pOiB2b2lkIHtcbiAgICBpZiAodGhpcy5jb25maWcuZGVidWcpIHtcbiAgICAgIGNvbnNvbGUubG9nKCd0b2dnbGVNdXRlU3RyZWFtKCknLCBzdHJlYW0sIHR5cGUsIHZhbHVlKTtcbiAgICB9XG4gICAgaWYgKHN0cmVhbSkge1xuICAgICAgaWYgKHN0cmVhbSBpbnN0YW5jZW9mIE1lZGlhU3RyZWFtVHJhY2spIHtcbiAgICAgICAgY29uc3QgdGFyZ2V0VmFsdWUgPSB0eXBlb2YgdmFsdWUgIT09ICd1bmRlZmluZWQnID8gdmFsdWUgOiAhc3RyZWFtLmVuYWJsZWQ7XG4gICAgICAgIHN0cmVhbS5lbmFibGVkID0gdGFyZ2V0VmFsdWU7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpZiAodHlwZSA9PT0gU3RyZWFtVHlwZS5BdWRpbykge1xuICAgICAgICAgIHN0cmVhbS5nZXRBdWRpb1RyYWNrcygpLmZvckVhY2godHJhY2sgPT4ge1xuICAgICAgICAgICAgY29uc3QgdGFyZ2V0VmFsdWUgPSB0eXBlb2YgdmFsdWUgIT09ICd1bmRlZmluZWQnID8gdmFsdWUgOiAhdHJhY2suZW5hYmxlZDtcbiAgICAgICAgICAgIHRyYWNrLmVuYWJsZWQgPSB0YXJnZXRWYWx1ZTtcbiAgICAgICAgICAgIHRoaXMubG9jYWxBdWRpb1N0cmVhbVN0YXR1c0NoYW5nZWQuZW1pdCh0YXJnZXRWYWx1ZSk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHR5cGUgPT09IFN0cmVhbVR5cGUuVmlkZW8pIHtcbiAgICAgICAgICBzdHJlYW0uZ2V0VmlkZW9UcmFja3MoKS5mb3JFYWNoKHRyYWNrID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHRhcmdldFZhbHVlID0gdHlwZW9mIHZhbHVlICE9PSAndW5kZWZpbmVkJyA/IHZhbHVlIDogIXRyYWNrLmVuYWJsZWQ7XG4gICAgICAgICAgICB0cmFjay5lbmFibGVkID0gdGFyZ2V0VmFsdWU7XG4gICAgICAgICAgICB0aGlzLmxvY2FsVmlkZW9TdHJlYW1TdGF0dXNDaGFuZ2VkLmVtaXQodGFyZ2V0VmFsdWUpO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMubG9jYWxTdHJlYW1TdGF0dXNDaGFuZ2VkLmVtaXQoc3RyZWFtKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBNdXRlIHN0cmVhbSBpbiBub2RlLlxuICAgKiBAcGFyYW0gc3RyZWFtIHN0cmFtIG9yIHRyYWNrXG4gICAqIEBwYXJhbSB0eXBlIHN0cmVhbSBvciB0cmFjayB0eXBlXG4gICAqL1xuICBwdWJsaWMgbXV0ZVN0cmVhbShzdHJlYW06IE1lZGlhU3RyZWFtIHwgTWVkaWFTdHJlYW1UcmFjaywgdHlwZTogU3RyZWFtVHlwZSk6IHZvaWQge1xuICAgIHRoaXMudG9nZ2xlTXV0ZVN0cmVhbShzdHJlYW0sIHR5cGUsIGZhbHNlKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBVbm11dGUgc3RyZWFtIGluIG5vZGUuXG4gICAqIEBwYXJhbSBzdHJlYW0gc3RyYW0gb3IgdHJhY2tcbiAgICogQHBhcmFtIHR5cGUgc3RyZWFtIG9yIHRyYWNrIHR5cGVcbiAgICovXG4gIHB1YmxpYyB1bm11dGVTdHJlYW0oc3RyZWFtOiBNZWRpYVN0cmVhbSB8IE1lZGlhU3RyZWFtVHJhY2ssIHR5cGU6IFN0cmVhbVR5cGUpOiB2b2lkIHtcbiAgICB0aGlzLnRvZ2dsZU11dGVTdHJlYW0oc3RyZWFtLCB0eXBlLCB0cnVlKTtcbiAgfVxuXG4gIC8qKlxuICAgKiByZXBsYWNlIGEgdHJhY2sgaW4gc3RyZWFtXG4gICAqIEBwYXJhbSBzdHJlYW0gc3RyZWFtIHdpdGggdGhyZSB0cmFjayB0byByZXBsYWNlXG4gICAqIEBwYXJhbSB0cmFjayBuZXcgdHJhY2tcbiAgICovXG4gIHB1YmxpYyByZXBsYWNlVHJhY2tJblN0cmVhbShzdHJlYW06IE1lZGlhU3RyZWFtLCB0cmFjazogTWVkaWFTdHJlYW1UcmFjayk6IHZvaWQge1xuICAgIGlmICh0cmFjay5raW5kID09PSBTdHJlYW1UeXBlLlZpZGVvKSB7XG4gICAgICBzdHJlYW0/LmdldFZpZGVvVHJhY2tzKCkuZm9yRWFjaChlID0+IHtcbiAgICAgICAgZS5zdG9wKCk7XG4gICAgICAgIHN0cmVhbS5yZW1vdmVUcmFjayhlKVxuICAgICAgfSk7XG4gICAgfVxuICAgIGlmICh0cmFjay5raW5kID09PSBTdHJlYW1UeXBlLkF1ZGlvKSB7XG4gICAgICBzdHJlYW0/LmdldEF1ZGlvVHJhY2tzKCkuZm9yRWFjaCgoZSkgPT4ge1xuICAgICAgICBlLnN0b3AoKTtcbiAgICAgICAgc3RyZWFtLnJlbW92ZVRyYWNrKGUpXG4gICAgICB9KTtcbiAgICB9XG4gICAgc3RyZWFtPy5hZGRUcmFjayh0cmFjayk7XG4gIH1cblxuICAvKipcbiAgICogc2V0IGxvY2FsIHN0cmVhbSBpbiBzZXJ2aWNlIHN0YXRlXG4gICAqIEBwYXJhbSBzdHJlYW0gc3RyZWFtIHRvIHNldFxuICAgKi9cbiAgcHVibGljIHNldExvY2FsU3RyZWFtKHN0cmVhbTogTWVkaWFTdHJlYW0gfCBudWxsKTogdm9pZCB7XG4gICAgdGhpcy5sb2NhbFN0cmVhbSQubmV4dChzdHJlYW0pO1xuICB9XG5cbiAgLyoqXG4gICAqIGdldCBjdXJyZW50IHN0YXRlIHZhbHVlIG9mIGxvY2FsIHN0cmVhbVxuICAgKiBAcmV0dXJucyBjdXJyZW50IGxvY2FsIHN0cmVhbVxuICAgKi9cbiAgcHVibGljIGdldExvY2FsU3RyZWFtKCk6IE1lZGlhU3RyZWFtIHwgbnVsbCB7XG4gICAgcmV0dXJuIHRoaXMubG9jYWxTdHJlYW0kLmdldFZhbHVlKCk7XG4gIH1cblxuICAvKipcbiAgICogc2V0IHJlcGxhY2UgdHJhY2sgc2VydmljZSBzdGF0ZS4gWW91IGNhbiBzdWJzY3JpYmUgdG8gYFN0cmVhbVNlcnZpY2UucmVwbGFjZVRyYWNrJGAgdG8gdXBkYXRlIHRoZSB0cmFjayBzb21ld2hlcmUuXG4gICAqIEBwYXJhbSB0cmFjayBuZXcgdHJhY2tcbiAgICovXG4gIHB1YmxpYyByZXBsYWNlVHJhY2sodHJhY2s6IE1lZGlhU3RyZWFtVHJhY2spOiB2b2lkIHtcbiAgICB0aGlzLnJlcGxhY2VUcmFjayQubmV4dCh0cmFjayk7XG4gIH1cblxuICAvKipcbiAgICogdG9nZ2xlIG11dGUgYXVkaW8gb2YgbG9jYWwgc3RyZWFtXG4gICAqL1xuICBwdWJsaWMgdG9nZ2xlTXV0ZUxvY2FsQXVkaW9TdHJlYW0oKTogdm9pZCB7XG4gICAgY29uc3Qgc3RyZWFtID0gdGhpcy5sb2NhbFN0cmVhbSQuZ2V0VmFsdWUoKTtcbiAgICBpZiAoc3RyZWFtKSB7XG4gICAgICB0aGlzLnRvZ2dsZU11dGVTdHJlYW0oc3RyZWFtLCBTdHJlYW1UeXBlLkF1ZGlvKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogbXV0ZSBsb2NhbCBhdWRpbyBzdHJlYW1cbiAgICovXG4gIHB1YmxpYyBtdXRlTG9jYWxBdWRpb1N0cmVhbSgpOiB2b2lkIHtcbiAgICBjb25zdCBzdHJlYW0gPSB0aGlzLmxvY2FsU3RyZWFtJC5nZXRWYWx1ZSgpO1xuICAgIGlmIChzdHJlYW0pIHtcbiAgICAgIHRoaXMudG9nZ2xlTXV0ZVN0cmVhbShzdHJlYW0sIFN0cmVhbVR5cGUuQXVkaW8sIGZhbHNlKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogdW5tdXRlIGxvY2FsIGF1ZGlvIHN0cmVhbVxuICAgKi9cbiAgcHVibGljIHVubXV0ZUxvY2FsQXVkaW9TdHJlYW0oKTogdm9pZCB7XG4gICAgY29uc3Qgc3RyZWFtID0gdGhpcy5sb2NhbFN0cmVhbSQuZ2V0VmFsdWUoKTtcbiAgICBpZiAoc3RyZWFtKSB7XG4gICAgICB0aGlzLnRvZ2dsZU11dGVTdHJlYW0oc3RyZWFtLCBTdHJlYW1UeXBlLkF1ZGlvLCB0cnVlKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogdG9nZ2xlIG11dGUgbG9jYWwgdmlkZW8gc3RyZWFtXG4gICAqL1xuICBwdWJsaWMgdG9nZ2xlTXV0ZUxvY2FsVmlkZW9TdHJlYW0oKTogdm9pZCB7XG4gICAgY29uc3Qgc3RyZWFtID0gdGhpcy5sb2NhbFN0cmVhbSQuZ2V0VmFsdWUoKTtcbiAgICBpZiAoc3RyZWFtKSB7XG4gICAgICB0aGlzLnRvZ2dsZU11dGVTdHJlYW0oc3RyZWFtLCBTdHJlYW1UeXBlLlZpZGVvKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogbXV0ZSBsb2NhbCB2aWRlbyBzdHJlYW1cbiAgICovXG4gIHB1YmxpYyBtdXRlTG9jYWxWaWRlb1N0cmVhbSgpOiB2b2lkIHtcbiAgICBjb25zdCBzdHJlYW0gPSB0aGlzLmxvY2FsU3RyZWFtJC5nZXRWYWx1ZSgpO1xuICAgIGlmIChzdHJlYW0pIHtcbiAgICAgIHRoaXMudG9nZ2xlTXV0ZVN0cmVhbShzdHJlYW0sIFN0cmVhbVR5cGUuVmlkZW8sIGZhbHNlKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogdW5tdXRlIGxvY2FsIHZpZGVvIHN0cmVhbVxuICAgKi9cbiAgcHVibGljIHVubXV0ZUxvY2FsVmlkZW9TdHJlYW0oKTogdm9pZCB7XG4gICAgY29uc3QgdmFsdWUgPSB0aGlzLmxvY2FsU3RyZWFtJC5nZXRWYWx1ZSgpO1xuICAgIGlmICh2YWx1ZSkge1xuICAgICAgdGhpcy50b2dnbGVNdXRlU3RyZWFtKHZhbHVlLCBTdHJlYW1UeXBlLlZpZGVvLCB0cnVlKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogZ2V0IHNjcmVlbiBvciB3aW5kb3cgYXMgc3RyZWFtXG4gICAqIEByZXR1cm5zIE1lZGlhU3RyYW0gb2YgZGVza3RvcCBvciBkaXNwbGF5XG4gICAqL1xuICBwdWJsaWMgYXN5bmMgZ2V0U2NyZWVuQ2FwdHVyZSgpOiBQcm9taXNlPE1lZGlhU3RyZWFtIHwgbnVsbD4ge1xuICAgIGxldCBzdHJlYW06IE1lZGlhU3RyZWFtIHwgbnVsbCA9IG51bGw7XG4gICAgdHJ5IHtcbiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZXhwbGljaXQtYW55XG4gICAgICBjb25zdCBuOiBhbnkgPSBuYXZpZ2F0b3I7XG4gICAgICBpZiAobi5nZXREaXNwbGF5TWVkaWEpIHtcbiAgICAgICAgc3RyZWFtID0gYXdhaXQgbi5nZXREaXNwbGF5TWVkaWEoeyB2aWRlbzogdHJ1ZSB9KTtcbiAgICAgIH0gZWxzZSBpZiAobi5tZWRpYURldmljZXMuZ2V0RGlzcGxheU1lZGlhKSB7XG4gICAgICAgIHN0cmVhbSA9IGF3YWl0IG4ubWVkaWFEZXZpY2VzLmdldERpc3BsYXlNZWRpYSh7IHZpZGVvOiB0cnVlIH0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgc3RyZWFtID0gYXdhaXQgbi5tZWRpYURldmljZXMuZ2V0VXNlck1lZGlhKHsgdmlkZW86IHsgbWVkaWFTb3VyY2U6ICdzY3JlZW4nIH0gfSk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgaWYgKHRoaXMuY29uZmlnLmRlYnVnKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKGBNZG9WaWRlb0NhbGxDb21wb25lbnQuZ2V0U2NyZWVuQ2FwdHVyZSgpIC0+IG5vIHBlcm1pc3Npb25zYCk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBzdHJlYW07XG4gIH1cblxuICAvKipcbiAgICogZ2V0IGZpcnN0L3NpbmdsZSB2aWRlbyB0cmFjayBvZiB0aGUgZ2l2ZW4gc3RyZWFtXG4gICAqIEBwYXJhbSBzdHJlYW0gc3RyZWFtIHdpdGggdmlkZW8gdHJlYWNrXG4gICAqIEByZXR1cm5zIGZpcnN0IHZpZGVvIHRyYWNrIG9mIHN0cmVhbVxuICAgKi9cbiAgcHVibGljIGdldFZpZGVvVHJhY2tGb3JTdHJlYW0oc3RyZWFtPzogTWVkaWFTdHJlYW0pOiBNZWRpYVN0cmVhbVRyYWNrIHwgbnVsbCB7XG4gICAgaWYgKCFzdHJlYW0gJiYgdGhpcy5nZXRMb2NhbFN0cmVhbSgpKSB7XG4gICAgICBzdHJlYW0gPSB0aGlzLmdldExvY2FsU3RyZWFtKCkgYXMgTWVkaWFTdHJlYW07XG4gICAgfVxuICAgIHJldHVybiBzdHJlYW0/LmdldFZpZGVvVHJhY2tzKClbMF0gfHwgbnVsbDtcbiAgfVxuXG4gIC8qKlxuICAgKiBnZXQgZmlyc3Qvc2luZ2xlIGF1ZGlvIHRyYWNrIG9mIHRoZSBnaXZlbiBzdHJlYW1cbiAgICogQHBhcmFtIHN0cmVhbSBzdHJlYW0gd2l0aCBhdWRpbyB0cmVhY2tcbiAgICogQHJldHVybnMgZmlyc3QgYXVkaW8gdHJhY2sgb2Ygc3RyZWFtXG4gICAqL1xuICBwdWJsaWMgZ2V0QXVkaW9UcmFja0ZvclN0cmVhbShzdHJlYW0/OiBNZWRpYVN0cmVhbSk6IE1lZGlhU3RyZWFtVHJhY2sgfCBudWxsIHtcbiAgICBpZiAoIXN0cmVhbSAmJiB0aGlzLmdldExvY2FsU3RyZWFtKCkpIHtcbiAgICAgIHN0cmVhbSA9IHRoaXMuZ2V0TG9jYWxTdHJlYW0oKSBhcyBNZWRpYVN0cmVhbTtcbiAgICB9XG4gICAgcmV0dXJuIHN0cmVhbT8uZ2V0QXVkaW9UcmFja3MoKVswXSB8fCBudWxsO1xuICB9XG5cbiAgLyoqXG4gICAqIGdldCBtZWRpYSBkZXZpY2VzLCBBdHRlbnRpb24geW91IG5lZWQgZ2V0TWVkaWEgcGVybWlzc2lvbnMgZm9yIHRoaXMgY2FsbFxuICAgKiBAcmV0dXJucyBQcm9taXNlIHRoYXQgcmVzb2x2ZXMgdG8gbWVkaWEgRGV2aWNlcyBhcyBhcnJheVxuICAgKiBAZGVwcmVjYXRlZCB1c2UgRGV2aWNlU2VydmljZS5nZXRNZWRpYURldmljZXMoKSBpbnN0ZWFkXG4gICAqL1xuICBwdWJsaWMgZ2V0TWVkaWFEZXZpY2VzKCk6IFByb21pc2U8TWVkaWFEZXZpY2VJbmZvW10+IHtcbiAgICByZXR1cm4gbmF2aWdhdG9yLm1lZGlhRGV2aWNlcy5lbnVtZXJhdGVEZXZpY2VzKCk7XG4gIH1cblxuICAvKipcbiAgICogc2V0IGN1cnJlbnQgYXVkaW8gZGV2aWNlIGluIHNlcnZpY2Ugc3RhdGUuIFlvdSBjYW4gc3Vic2NyaWJlIHRvIGBTdHJlYW1TZXJ2aWNlLmF1ZGlvT3V0cHV0JGAgdG8gZ2V0IGNoYW5nZXMuXG4gICAqIEBwYXJhbSBkZXZpY2VJZCBcbiAgICovXG4gIHB1YmxpYyBzZXRBdWRpb091dHB1dChkZXZpY2VJZDogc3RyaW5nKTogdm9pZCB7XG4gICAgdGhpcy5hdWRpb091dHB1dCQubmV4dChkZXZpY2VJZCk7XG4gIH1cblxuICAvLyBUT0RPOiByZWZhY3RvclxuICAvKipcbiAgICogQW4gc2ltcGxlIHdyYXBwZXIgZm9yIGBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLmdldFVzZXJNZWRpYWAsIHdpdGggYmFzaXMgZXJyb3IgaGFuZGxpbmcuXG4gICAqIEB0b2RvIHJlZmFjdG9yXG4gICAqIEBwYXJhbSBtZWRpYUNvbnN0cmFpbnRzIGEgTWVkaWFTdHJlYW1Db25zdHJhaW50cyBlLmcuIHdpdGggc3BlY2lmaWMgZGV2aWNlSWQsIHJlc29sdXRpb24gb3IganVzdCBhdWRpby4gRGVmYXVsdCBpczpcbiAgICogICAgICAgICAgICAgICAgICAgICAgICAgIGBgYGpzb25cbiAgICogICAgICAgICAgICAgICAgICAgICAgICAge1xuICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXVkaW86IHRydWUsXG4gICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2aWRlbzogdHJ1ZVxuICAgKiAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAqICAgICAgICAgICAgICAgICAgICAgICAgIGBgYFxuICAgKiBAcmV0dXJucyBQcm9taXNlIHRoYXQgcmVzaWx2ZSB0byBhIHN0cmVhbSBtYXRjaGluZyB0aGUgY29uc3RyYWludFxuICAgKiBAZGVwcmVjYXRlZCB1c2UgRGV2aWNlU2VydmljZS50cnlHZXRVc2VyTWVkaWEoKSBpbnN0ZWFkXG4gICAqL1xuICBwdWJsaWMgdHJ5R2V0VXNlck1lZGlhKG1lZGlhQ29uc3RyYWludHM/OiBNZWRpYVN0cmVhbUNvbnN0cmFpbnRzKTogUHJvbWlzZTxNZWRpYVN0cmVhbT4ge1xuICAgIC8vIHJlc2V0IHN0YXRlXG4gICAgdGhpcy5oYXNBdWRpbyA9IGZhbHNlO1xuICAgIHRoaXMuaGFzVmlkZW8gPSBmYWxzZTtcblxuICAgIGlmICghbWVkaWFDb25zdHJhaW50cykge1xuICAgICAgbWVkaWFDb25zdHJhaW50cyA9IHtcbiAgICAgICAgYXVkaW86IHRydWUsXG4gICAgICAgIHZpZGVvOiB0cnVlXG4gICAgICB9XG4gICAgfTtcblxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLmdldFVzZXJNZWRpYShtZWRpYUNvbnN0cmFpbnRzKS50aGVuKGEgPT4ge1xuICAgICAgICB0aGlzLmhhc0F1ZGlvID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5oYXNWaWRlbyA9IHRydWU7XG4gICAgICAgIHJlc29sdmUoYSk7XG4gICAgICB9LCBiID0+IHtcbiAgICAgICAgbGV0IGNhbSA9IHRydWUsIG1pYyA9IHRydWU7XG4gICAgICAgIGlmIChiLm1lc3NhZ2UuaW5kZXhPZignU3RhcnRpbmcgdmlkZW9pbnB1dCBmYWlsZWQnKSA+IC0xKSB7XG4gICAgICAgICAgaWYodGhpcy5jb25maWcuZGVidWcpIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCd2aWRlb2lucHV0IHVzZWQgYnkgYW5vdGhlciBzb2Z0d2FyZScpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBjYW0gPSBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLmVudW1lcmF0ZURldmljZXMoKS50aGVuKChkZXZpY2VzKSA9PiB7XG4gICAgICAgICAgY2FtID0gY2FtICYmIGRldmljZXMuZmluZCgoZGV2aWNlKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gZGV2aWNlLmtpbmQgPT09ICd2aWRlb2lucHV0JztcbiAgICAgICAgICB9KSAhPT0gbnVsbDtcbiAgICAgICAgICBtaWMgPSBkZXZpY2VzLmZpbmQoKGRldmljZSkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIGRldmljZS5raW5kID09PSAnYXVkaW9pbnB1dCc7XG4gICAgICAgICAgfSkgIT09IG51bGw7XG4gICAgICAgICAgY29uc3QgY29uc3RyYWludHMgPSB7XG4gICAgICAgICAgICB2aWRlbzogY2FtICYmIG1lZGlhQ29uc3RyYWludHM/LnZpZGVvLFxuICAgICAgICAgICAgYXVkaW86IG1pYyAmJiBtZWRpYUNvbnN0cmFpbnRzPy5hdWRpb1xuICAgICAgICAgIH07XG4gICAgICAgICAgbmF2aWdhdG9yLm1lZGlhRGV2aWNlcy5nZXRVc2VyTWVkaWEoY29uc3RyYWludHMpLnRoZW4oYSA9PiB7XG4gICAgICAgICAgICB0aGlzLmhhc0F1ZGlvID0gdHJ1ZTtcbiAgICAgICAgICAgIHJlc29sdmUoYSk7XG4gICAgICAgICAgfSwgcmVqZWN0KTtcbiAgICAgICAgfSwgKGYpID0+IHtcbiAgICAgICAgICByZWplY3QoZik7XG4gICAgICAgIH0pO1xuICAgICAgfSkuY2F0Y2goZSA9PiB7XG4gICAgICAgIHJlamVjdChlKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG59XG4iXX0=